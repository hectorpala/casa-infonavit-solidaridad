<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Interno | Culiacán CRM</title>
    <meta name="robots" content="noindex,nofollow">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#FF6A00',
                        'primary-dark': '#D35500'
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif']
                    }
                }
            }
        };
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #f5f6fb;
        }
        .shadow-zillow {
            box-shadow: 0 18px 35px rgba(15, 23, 42, 0.08);
        }
        .table-scroll {
            scrollbar-width: thin;
        }
        .table-scroll::-webkit-scrollbar {
            height: 6px;
        }
        .table-scroll::-webkit-scrollbar-thumb {
            background: rgba(15, 23, 42, 0.25);
            border-radius: 999px;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <header class="bg-white shadow-sm sticky top-0 z-40 border-b border-slate-200">
        <div class="max-w-7xl mx-auto px-4 lg:px-6 py-3 flex items-center justify-between gap-6">
            <a href="/culiacan/" class="flex items-center gap-3">
                <svg class="w-10 h-10 text-primary" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 3L2 12h3v8h6v-6h2v6h6v-8h3L12 3zm0 2.8L18 11v8h-2v-6h-6v6H8v-8l4-5.2z"/>
                </svg>
                <div class="hidden sm:flex flex-col leading-tight">
                    <span class="text-[11px] font-semibold uppercase tracking-[0.2em] text-slate-400">Hector es Bienes Raíces</span>
                    <span class="text-sm md:text-base font-semibold text-slate-700">Culiacán · Panel interno</span>
                </div>
            </a>
            <div class="flex items-center gap-2 text-xs sm:text-sm font-semibold text-slate-600">
                <span class="px-3 py-1 rounded-full bg-primary/10 text-primary">Privado</span>
                <a href="/crm-inmuebles24.html" class="inline-flex items-center gap-2 px-3 py-2 rounded-full border border-slate-200 hover:border-primary transition-colors">
                    <i class="fa-solid fa-database"></i>
                    CRM completo
                </a>
            </div>
        </div>
        <div class="border-t border-slate-200 bg-white/90 backdrop-blur">
            <div class="max-w-7xl mx-auto px-4 lg:px-6 py-3 grid grid-cols-1 md:grid-cols-3 gap-3">
                <div class="flex flex-col">
                    <span class="text-xs uppercase tracking-[0.18em] text-slate-400">Propiedades</span>
                    <span id="summary-props" class="text-lg font-semibold text-slate-800">0</span>
                </div>
                <div class="flex flex-col">
                    <span class="text-xs uppercase tracking-[0.18em] text-slate-400">En renta</span>
                    <span id="summary-rentas" class="text-lg font-semibold text-slate-800">0</span>
                </div>
                <div class="flex flex-col">
                    <span class="text-xs uppercase tracking-[0.18em] text-slate-400">Vendedores</span>
                    <span id="summary-vendors" class="text-lg font-semibold text-slate-800">0</span>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 lg:px-6 py-8 space-y-10">
        <section class="bg-white shadow-zillow rounded-3xl border border-slate-200 p-6 space-y-6">
            <div class="flex flex-wrap items-center gap-4">
                <div class="flex-1">
                    <h2 class="text-xl font-semibold text-slate-800">Propiedades (CRM)</h2>
                    <p class="text-sm text-slate-500">Listado consolidado con información interna y métricas de antigüedad.</p>
                </div>
                <div class="flex items-center gap-3 w-full md:w-auto">
                    <input id="property-search" type="search" placeholder="Buscar por título, agente, ubicación…" class="flex-1 md:w-72 px-4 py-2 rounded-full border border-slate-300 focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary text-sm">
                    <select id="property-type-filter" class="px-4 py-2 rounded-full border border-slate-300 text-sm focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary">
                        <option value="">Tipo: Todos</option>
                        <option value="venta">Solo venta</option>
                        <option value="renta">Solo renta</option>
                    </select>
                    <select id="property-agent-filter" class="px-4 py-2 rounded-full border border-slate-300 text-sm focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary">
                        <option value="">Agente: Todos</option>
                    </select>
                </div>
            </div>

            <div class="overflow-x-auto table-scroll">
                <table class="min-w-full text-left text-sm text-slate-600">
                    <thead class="bg-slate-100 text-xs uppercase tracking-[0.15em] text-slate-500">
                        <tr>
                            <th class="px-4 py-3 font-semibold">Propiedad</th>
                            <th class="px-4 py-3 font-semibold">Ubicación</th>
                            <th class="px-4 py-3 font-semibold">Precio</th>
                            <th class="px-4 py-3 font-semibold">Habitaciones</th>
                            <th class="px-4 py-3 font-semibold">Agente / Inmobiliaria</th>
                            <th class="px-4 py-3 font-semibold">Agregado</th>
                            <th class="px-4 py-3 font-semibold text-right">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="properties-table" class="divide-y divide-slate-100">
                        <!-- Rows injected via JS -->
                    </tbody>
                </table>
            </div>
        </section>

        <section class="bg-white shadow-zillow rounded-3xl border border-slate-200 p-6 space-y-6">
            <div class="flex flex-wrap items-center gap-4">
                <div class="flex-1">
                    <h2 class="text-xl font-semibold text-slate-800">Vendedores</h2>
                    <p class="text-sm text-slate-500">Datos de contacto registrados en el CRM y propiedades asociadas.</p>
                </div>
                <div class="w-full md:w-auto flex items-center gap-3">
                    <input id="vendor-search" type="search" placeholder="Buscar por nombre, teléfono, tag…" class="flex-1 md:w-80 px-4 py-2 rounded-full border border-slate-300 focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary text-sm">
                    <select id="vendor-tag-filter" class="px-4 py-2 rounded-full border border-slate-300 text-sm focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary">
                        <option value="">Tag: Todos</option>
                    </select>
                </div>
            </div>

            <div class="overflow-x-auto table-scroll">
                <table class="min-w-full text-left text-sm text-slate-600">
                    <thead class="bg-slate-100 text-xs uppercase tracking-[0.15em] text-slate-500">
                        <tr>
                            <th class="px-4 py-3 font-semibold">Vendedor</th>
                            <th class="px-4 py-3 font-semibold">Contacto</th>
                            <th class="px-4 py-3 font-semibold">Fuente</th>
                            <th class="px-4 py-3 font-semibold">Propiedades registradas</th>
                            <th class="px-4 py-3 font-semibold">Tags</th>
                            <th class="px-4 py-3 font-semibold text-right">Último contacto</th>
                        </tr>
                    </thead>
                    <tbody id="vendors-table" class="divide-y divide-slate-100">
                        <!-- Vendor rows inserted via JS -->
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <footer class="bg-white border-t border-slate-200 py-6 text-sm text-slate-500">
        <div class="max-w-7xl mx-auto px-4 lg:px-6 flex flex-wrap items-center justify-between gap-3">
            <span>CRM interno · Solo uso personal · {{year}}</span>
            <span>Hector es Bienes Raíces</span>
        </div>
    </footer>

    <script src="https://kit.fontawesome.com/9c77b9aacf.js" crossorigin="anonymous"></script>
    <script>
        const numberFormatter = new Intl.NumberFormat('es-MX');
        const dateFormatter = new Intl.DateTimeFormat('es-MX', { year: 'numeric', month: 'short', day: 'numeric' });

        async function loadCRMData() {
            try {
                const [propsRes, vendorsRes] = await Promise.all([
                    fetch('../crm-propiedades.json'),
                    fetch('../crm-vendedores.json')
                ]);

                if (!propsRes.ok || !vendorsRes.ok) {
                    throw new Error('No se pudo cargar CRM');
                }

                const propsData = await propsRes.json();
                const vendorsData = await vendorsRes.json();

                renderProperties(propsData.propiedades || []);
                renderVendors(vendorsData.vendedores || []);
                hydrateFilters(propsData.propiedades || [], vendorsData.vendedores || []);
                updateSummaries(propsData.propiedades || [], vendorsData.vendedores || []);
            } catch (error) {
                console.error('Error al cargar CRM', error);
                document.getElementById('properties-table').innerHTML = '<tr><td colspan="7" class="px-4 py-6 text-red-500">No se pudieron cargar los datos del CRM.</td></tr>';
            }
        }

        function updateSummaries(properties, vendors) {
            const total = properties.length;
            const rentas = properties.filter(p => (p.tipo || '').toLowerCase() === 'renta' || /\/mes|renta/i.test(p.precio || '')).length;
            document.getElementById('summary-props').textContent = total;
            document.getElementById('summary-rentas').textContent = rentas;
            document.getElementById('summary-vendors').textContent = vendors.length;
        }

        function hydrateFilters(properties, vendors) {
            const agentFilter = document.getElementById('property-agent-filter');
            const uniqueAgents = [...new Set(properties.map(p => (p.agente || '').trim()).filter(Boolean))].sort();
            uniqueAgents.forEach(agent => {
                const option = document.createElement('option');
                option.value = agent;
                option.textContent = agent;
                agentFilter.appendChild(option);
            });

            const vendorTagFilter = document.getElementById('vendor-tag-filter');
            const tags = new Set();
            vendors.forEach(v => (v.tags || []).forEach(tag => tags.add(tag)));
            Array.from(tags).sort().forEach(tag => {
                const option = document.createElement('option');
                option.value = tag;
                option.textContent = tag;
                vendorTagFilter.appendChild(option);
            });
        }

        function renderProperties(properties) {
            const tbody = document.getElementById('properties-table');
            if (!properties.length) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-6 text-slate-400">Sin propiedades registradas en el CRM.</td></tr>';
                return;
            }

            const rows = properties.map(prop => {
                const slugUrl = `/culiacan/${prop.slug}/`;
                const rooms = `${prop.recamaras || '-'} rec / ${prop.banos || '-'} baños`;
                const agentInfo = `
                    <div class="flex flex-col">
                        <span class="font-semibold text-slate-700">${prop.agente || '—'}</span>
                        <span class="text-xs text-slate-400">${prop.inmobiliaria || '—'}</span>
                    </div>
                `;
                const addedDate = prop.fechaAgregada ? dateFormatter.format(new Date(prop.fechaAgregada)) : '—';
                const daysOnMarket = prop.fechaAgregada ? Math.max(0, Math.round((Date.now() - new Date(prop.fechaAgregada)) / (1000 * 60 * 60 * 24))) : null;
                const daysBadge = daysOnMarket !== null ? `<span class="inline-flex items-center text-xs px-2 py-1 rounded-full bg-slate-100 text-slate-600">${daysOnMarket} días</span>` : '';
                const typeBadge = getTypeBadge(prop);

                return `
                    <tr class="hover:bg-slate-50 transition">
                        <td class="px-4 py-4 max-w-xs">
                            <div class="flex flex-col gap-1">
                                <a href="${slugUrl}" target="_blank" class="text-slate-800 font-semibold hover:text-primary transition">${prop.titulo || prop.slug}</a>
                                <span class="text-xs text-slate-400 break-all">${prop.slug}</span>
                                <div class="flex items-center gap-2">${typeBadge} ${daysBadge}</div>
                            </div>
                        </td>
                        <td class="px-4 py-4 text-sm text-slate-600">${prop.ubicacion || '—'}</td>
                        <td class="px-4 py-4 text-sm font-semibold text-slate-800">$${numberFormatter.format(parseInt((prop.precio || '0').replace(/[^\d]/g, '')) || 0)}</td>
                        <td class="px-4 py-4 text-sm text-slate-600">${rooms}</td>
                        <td class="px-4 py-4">${agentInfo}</td>
                        <td class="px-4 py-4 text-sm text-slate-600">${addedDate}</td>
                        <td class="px-4 py-4 text-right">
                            <a href="${slugUrl}" target="_blank" class="inline-flex items-center gap-1 text-sm font-semibold text-primary hover:text-primary-dark transition">
                                Ver ficha
                                <i class="fa-solid fa-arrow-up-right-from-square text-xs"></i>
                            </a>
                        </td>
                    </tr>
                `;
            }).join('');

            tbody.innerHTML = rows;
        }

        function getTypeBadge(prop) {
            const tipoInferido = (prop.tipo || '').toLowerCase();
            if (tipoInferido === 'renta' || /\/mes|renta/i.test(prop.precio || '')) {
                return '<span class="inline-flex items-center text-xs px-2 py-1 rounded-full bg-orange-100 text-orange-700 font-semibold">Renta</span>';
            }
            if (tipoInferido === 'venta') {
                return '<span class="inline-flex items-center text-xs px-2 py-1 rounded-full bg-emerald-100 text-emerald-700 font-semibold">Venta</span>';
            }
            return '<span class="inline-flex items-center text-xs px-2 py-1 rounded-full bg-slate-100 text-slate-600">Sin tipo</span>';
        }

        function renderVendors(vendors) {
            const tbody = document.getElementById('vendors-table');
            if (!vendors.length) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-6 text-slate-400">Sin vendedores registrados.</td></tr>';
                return;
            }

            const rows = vendors.map(vendor => {
                const propsList = (vendor.propiedades || []).map(p => `
                    <li>
                        <a href="${p.url}" target="_blank" class="text-primary hover:text-primary-dark font-semibold text-sm">
                            ${p.titulo || p.id}
                        </a>
                        <span class="block text-xs text-slate-400">${p.precio || '—'} · ${p.fechaScrapeo || ''}</span>
                    </li>
                `).join('');

                const tags = (vendor.tags || []).map(tag => `
                    <span class="inline-flex items-center px-2 py-1 text-xs bg-slate-100 text-slate-500 rounded-full">${tag}</span>
                `).join('');

                const lastContact = vendor.ultimoContacto ? dateFormatter.format(new Date(vendor.ultimoContacto)) : '—';

                return `
                    <tr class="hover:bg-slate-50 transition">
                        <td class="px-4 py-4">
                            <div class="flex flex-col gap-1">
                                <span class="font-semibold text-slate-800">${vendor.nombre || '—'}</span>
                                <span class="text-xs text-slate-400">${vendor.id || ''}</span>
                            </div>
                        </td>
                        <td class="px-4 py-4 text-sm text-slate-600">
                            <div class="flex flex-col gap-1">
                                <a href="${vendor.whatsapp || '#'}" target="_blank" class="text-primary hover:text-primary-dark inline-flex items-center gap-1">
                                    <i class="fa-brands fa-whatsapp text-sm"></i>
                                    ${vendor.telefonoFormateado || vendor.telefono || '—'}
                                </a>
                                <span class="text-xs text-slate-400">${vendor.fuente || ''}</span>
                            </div>
                        </td>
                        <td class="px-4 py-4 text-sm text-slate-600">${vendor.fuente || '—'}</td>
                        <td class="px-4 py-4 text-sm text-slate-600">
                            <ul class="space-y-1">${propsList || '<li class="text-xs text-slate-400">Sin registros</li>'}</ul>
                        </td>
                        <td class="px-4 py-4 text-sm text-slate-600"><div class="flex flex-wrap gap-2">${tags}</div></td>
                        <td class="px-4 py-4 text-sm text-right text-slate-600">${lastContact}</td>
                    </tr>
                `;
            }).join('');

            tbody.innerHTML = rows;
        }

        function applyPropertyFilters() {
            const searchText = document.getElementById('property-search').value.toLowerCase();
            const typeFilter = document.getElementById('property-type-filter').value;
            const agentFilter = document.getElementById('property-agent-filter').value;
            const rows = Array.from(document.querySelectorAll('#properties-table tr'));

            rows.forEach(row => {
                const text = row.innerText.toLowerCase();
                const matchesSearch = !searchText || text.includes(searchText);
                const matchesAgent = !agentFilter || row.innerText.includes(agentFilter);
                let matchesType = true;
                if (typeFilter) {
                    matchesType = row.innerText.toLowerCase().includes(typeFilter === 'renta' ? 'renta' : 'venta');
                }
                row.style.display = (matchesSearch && matchesAgent && matchesType) ? '' : 'none';
            });
        }

        function applyVendorFilters() {
            const search = document.getElementById('vendor-search').value.toLowerCase();
            const tag = document.getElementById('vendor-tag-filter').value;
            const rows = Array.from(document.querySelectorAll('#vendors-table tr'));

            rows.forEach(row => {
                const text = row.innerText.toLowerCase();
                const matchesSearch = !search || text.includes(search);
                const matchesTag = !tag || row.innerText.includes(tag);
                row.style.display = (matchesSearch && matchesTag) ? '' : 'none';
            });
        }

        document.getElementById('property-search').addEventListener('input', applyPropertyFilters);
        document.getElementById('property-type-filter').addEventListener('change', applyPropertyFilters);
        document.getElementById('property-agent-filter').addEventListener('change', applyPropertyFilters);
        document.getElementById('vendor-search').addEventListener('input', applyVendorFilters);
        document.getElementById('vendor-tag-filter').addEventListener('change', applyVendorFilters);

        // inicialización
        document.addEventListener('DOMContentLoaded', () => {
            loadCRMData();
            document.body.innerHTML = document.body.innerHTML.replace('{{year}}', new Date().getFullYear());
        });
    </script>
</body>
</html>

