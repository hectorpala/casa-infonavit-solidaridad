#!/usr/bin/env node

/**
 * PIPELINE COMPLETO PARA ESPACIOS MARSELLA
 * SPEC orchestration-v1.1 + props-v3.3
 * Casa en Renta Colonia Espacios Marsella - ID: 30044981
 */

const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');

// Importar Pipeline16AgentesCompletoV2
const Pipeline16AgentesCompletoV2 = require('./automation/pipeline-16-agentes-completo-v2.js');

class PipelineEspaciosMarsella extends Pipeline16AgentesCompletoV2 {
    constructor() {
        super();
        
        // Override rutas espec√≠ficas para Espacios Marsella
        this.proyectosPath = '/Users/hectorpc/Documents/Hector Palazuelos/PROYECTOS';
        this.carpetaFotos = 'casa en retan colonia espacios marsella';
        this.rutaFotosCompleta = path.join(this.proyectosPath, this.carpetaFotos);
        
        // Datos espec√≠ficos de la propiedad
        this.datosPropiedad = {
            nombre: 'Casa en Renta Colonia Espacios Marsella',
            ubicacion: 'Privada Espacios Marsella, a 5 minutos de la escuela de medicina UAS',
            precio: '$12,000',
            precioNumero: 12000,
            tipo: 'renta',
            idInmueble: '30044981',
            recamaras: '2',
            banos: '2',
            caracteristicas: '2 Habitaciones, 2 Ba√±os, Cuarto de lavado, Cocina equipada, 2 Estacionamientos, Privada con acceso controlado, Pasillo de servicio, √Årea de sala, √Årea de comedor',
            amenidades: 'Privada con acceso controlado, Estacionamientos cubiertos, Cerca de UAS',
            edad: 'Nuevo',
            incluye: 'Incluye mantenimiento de privada'
        };
    }

    /**
     * AGENTE 2 OVERRIDE - ESC√ÅNER FOTOS (Espacios Marsella espec√≠fico)
     */
    async agente2_escanerFotos() {
        this.log(2, 'Escaneando fotos espec√≠ficas de Espacios Marsella');
        
        // Verificar carpeta espec√≠fica
        if (!fs.existsSync(this.rutaFotosCompleta)) {
            this.log(2, `Carpeta no encontrada: ${this.rutaFotosCompleta}`, 'ERROR');
            return false;
        }
        
        this.handoffData.fotosPath = this.rutaFotosCompleta;
        this.log(2, `Carpeta confirmada: ${this.carpetaFotos}`);
        
        // Validar fotos
        const archivos = fs.readdirSync(this.handoffData.fotosPath)
            .filter(file => /\.(jpg|jpeg|png|webp)$/i.test(file))
            .sort();
        
        this.log(2, `Fotos encontradas: ${archivos.join(', ')}`);
        
        if (archivos.length < 6) {
            this.log(2, `Solo ${archivos.length} fotos encontradas, m√≠nimo 6 requerido`, 'ERROR');
            return false;
        }
        
        this.handoffData.fotosValidas = archivos;
        
        // Detectar fachada - buscar foto-01 o primera foto
        this.handoffData.fachada = archivos.find(f => f.includes('foto-01')) || archivos[0];
        
        this.log(2, `${archivos.length} fotos v√°lidas detectadas`, 'SUCCESS');
        this.log(2, `Fachada principal: ${this.handoffData.fachada}`);
        
        return true;
    }

    /**
     * AGENTE 5 OVERRIDE - DETECTOR DUPLICADOS (slug espec√≠fico)
     */
    async agente5_detectorDuplicados() {
        this.log(5, 'Generando slug √∫nico para Espacios Marsella');
        
        const slugBase = 'casa-renta-espacios-marsella';
        
        // Verificar si existe
        const archivoExistente = `${slugBase}.html`;
        const slugExiste = fs.existsSync(archivoExistente);
        
        if (slugExiste) {
            this.log(5, `Slug ${slugBase} ya existe - generando variante`, 'ERROR');
            // Podr√≠amos generar casa-renta-espacios-marsella-2, etc.
            return false;
        }
        
        this.handoffData.slug = slugBase;
        this.handoffData.slugUnico = true;
        
        this.log(5, `Slug √∫nico confirmado: ${slugBase}`, 'SUCCESS');
        return true;
    }

    /**
     * AGENTE 12 OVERRIDE - GUARDIA PRE-PUBLICACI√ìN (validaci√≥n espec√≠fica)
     */
    async agente12_guardiaPrePublicacion() {
        this.log(12, 'Ejecutando verificaciones espec√≠ficas Espacios Marsella');
        
        let score = 0;
        const checks = [];
        
        // Verificar p√°gina HTML generada
        if (this.handoffData.paginaHTML && this.handoffData.paginaHTML.length > 1000) {
            score += 20;
            checks.push('‚úÖ P√°gina HTML generada correctamente');
            
            // Verificar template de renta espec√≠fico
            if (this.handoffData.paginaHTML.includes('Renta Mensual') && 
                this.handoffData.paginaHTML.includes('Calculadora de Renta')) {
                score += 10;
                checks.push('‚úÖ Template de renta aplicado correctamente');
            } else {
                checks.push('‚ùå Template de renta no detectado');
            }
        } else {
            checks.push('‚ùå P√°gina HTML faltante o incompleta');
        }
        
        // Verificar im√°genes f√≠sicas con slug correcto
        const slug = this.handoffData.slug; // casa-renta-espacios-marsella
        const slugImagenes = 'espacios-marsella'; // Para directorio de im√°genes
        const directorioImagenes = `./images/${slugImagenes}`;
        
        if (fs.existsSync(directorioImagenes)) {
            const imagenesEnDisco = fs.readdirSync(directorioImagenes);
            if (imagenesEnDisco.length >= 10) {
                score += 20;
                checks.push(`‚úÖ ${imagenesEnDisco.length} im√°genes optimizadas en disco`);
                
                // Verificar fotos espec√≠ficas de Espacios Marsella
                const tieneFoto01 = imagenesEnDisco.some(img => img.includes('foto-01'));
                if (tieneFoto01) {
                    score += 5;
                    checks.push('‚úÖ Fachada principal (foto-01) detectada');
                }
            } else {
                checks.push(`‚ùå Solo ${imagenesEnDisco.length} im√°genes en disco, esperado ‚â•10`);
            }
        } else {
            checks.push(`‚ùå Directorio de im√°genes no existe: ${directorioImagenes}`);
        }
        
        // Verificar carruseles con estructura carousel-container > carousel-wrapper
        if (this.handoffData.paginaHTML) {
            const tieneCarouselContainer = this.handoffData.paginaHTML.includes('carousel-container');
            const tieneCarouselWrapper = this.handoffData.paginaHTML.includes('carousel-wrapper');
            
            if (tieneCarouselContainer && tieneCarouselWrapper) {
                score += 15;
                checks.push('‚úÖ Estructura carrusel container > wrapper correcta');
            } else {
                checks.push('‚ùå Estructura carrusel incorrecta o faltante');
            }
        }
        
        // Verificar calculadora de renta
        if (this.handoffData.paginaHTML && 
            this.handoffData.paginaHTML.includes('calcularRenta') &&
            this.handoffData.paginaHTML.includes('PROPERTY_PRICE_NUMBER')) {
            score += 10;
            checks.push('‚úÖ Calculadora de renta integrada');
        } else {
            checks.push('‚ùå Calculadora de renta faltante');
        }
        
        // Verificar WhatsApp con mensaje espec√≠fico
        if (this.handoffData.whatsappConfigurado) {
            score += 10;
            checks.push('‚úÖ Enlaces WhatsApp E.164 configurados');
        } else {
            checks.push('‚ùå Enlaces WhatsApp faltantes');
        }
        
        // Verificar SEO para propiedad de renta
        if (this.handoffData.seoCompleto && this.handoffData.schemaMarkup) {
            score += 10;
            checks.push('‚úÖ SEO y Schema markup para renta aplicados');
        } else {
            checks.push('‚ùå SEO o Schema markup faltantes');
        }
        
        // Verificar actualizaciones √≠ndices
        if (this.handoffData.ambosIndicesActualizados) {
            score += 10;
            checks.push('‚úÖ Ambos √≠ndices actualizados');
        } else {
            checks.push('‚ùå √çndices no actualizados');
        }
        
        this.handoffData.scoreCalidad = score;
        this.handoffData.verificacionesFinales = score >= 85;
        this.handoffData.readyToPublish = score >= 85;
        
        // Mostrar resultados espec√≠ficos
        console.log('\nüìä REPORTE VERIFICACIONES ESPACIOS MARSELLA:');
        console.log('‚ïê'.repeat(55));
        checks.forEach(check => console.log(check));
        console.log(`\nüéØ SCORE DE CALIDAD: ${score}/100`);
        
        if (this.handoffData.readyToPublish) {
            this.log(12, `‚úÖ ESPACIOS MARSELLA READY TO PUBLISH - Score: ${score}/100`, 'SUCCESS');
            return true;
        } else {
            this.log(12, `‚ùå Espacios Marsella NO READY - Score: ${score}/100`, 'ERROR');
            return false;
        }
    }

    // Override generador de slug temporal
    generarSlugTemporal() {
        return 'espacios-marsella';
    }
    
    generarSlugImagenes() {
        return 'espacios-marsella';
    }

    /**
     * Override de generaci√≥n de WhatsApp URL con mensaje espec√≠fico
     */
    generarWhatsAppURL() {
        const mensaje = `Hola, me interesa la Casa en Renta Colonia Espacios Marsella por $12,000 mensual. ID: 30044981. ¬øPodr√≠as darme m√°s informaci√≥n?`;
        return `https://wa.me/528111652545?text=${encodeURIComponent(mensaje)}`;
    }

    /**
     * M√âTODO PRINCIPAL ESPEC√çFICO PARA ESPACIOS MARSELLA
     */
    async ejecutarPipelineEspaciosMarsella(okToApply = false) {
        console.log('üè† EJECUTANDO PIPELINE ESPACIOS MARSELLA');
        console.log('üìã SPEC: orchestration-v1.1 + props-v3.3 + rental-v2.1');
        console.log('üÜî ID Inmueble: 30044981');
        console.log('üí∞ Renta: $12,000 mensual (incluye mantenimiento)');
        console.log('‚ïê'.repeat(60));
        
        // Usar datos espec√≠ficos de la propiedad
        const resultado = await this.ejecutarPipelineCompleto(this.datosPropiedad, okToApply);
        
        if (resultado.success) {
            console.log('\nüéâ PIPELINE ESPACIOS MARSELLA COMPLETADO');
            console.log('‚ïê'.repeat(50));
            console.log(`üìÑ Archivo: ${this.handoffData.slug}.html`);
            console.log(`üìä Score: ${this.handoffData.scoreCalidad}/100`);
            console.log(`üîó URL: https://casasenventa.info/${this.handoffData.slug}.html`);
            console.log(`üì± WhatsApp: ${this.generarWhatsAppURL()}`);
            
            if (this.handoffData.readyToPublish) {
                console.log('\n‚úÖ ESTADO: READY TO PUBLISH');
                if (okToApply) {
                    console.log('üöÄ PUBLICACI√ìN AUTORIZADA');
                } else {
                    console.log('‚è≥ Esperando OK_TO_APPLY=true para publicar');
                }
            } else {
                console.log('\n‚ö†Ô∏è ESTADO: NEEDS REVIEW');
            }
        }
        
        return resultado;
    }
}

// Ejecutar pipeline si se llama directamente
if (require.main === module) {
    const pipeline = new PipelineEspaciosMarsella();
    const okToApply = process.argv.includes('--apply');
    
    pipeline.ejecutarPipelineEspaciosMarsella(okToApply)
        .then(resultado => {
            if (resultado.success) {
                console.log('\nüéØ RESULTADO FINAL: √âXITO');
                if (okToApply && resultado.readyToPublish) {
                    console.log('üìù Archivo HTML creado y listo para commit');
                    console.log('\nüöÄ Siguiente paso: ejecutar "publica ya"');
                }
            } else {
                console.log(`\n‚ùå PIPELINE FALL√ì EN AGENTE ${resultado.stoppedAt}`);
                process.exit(1);
            }
        })
        .catch(error => {
            console.error('üí• ERROR FATAL:', error);
            process.exit(1);
        });
}

module.exports = PipelineEspaciosMarsella;