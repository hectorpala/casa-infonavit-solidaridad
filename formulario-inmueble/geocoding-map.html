<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geocodificación con Mapa | Cotizador de Inmuebles</title>

    <!-- SEO Meta Tags -->
    <meta name="description" content="Herramienta de geocodificación para obtener coordenadas exactas de propiedades en Culiacán y Mazatlán, Sinaloa.">
    <meta name="keywords" content="geocodificación, mapa, coordenadas, dirección, Culiacán, Mazatlán">

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico">

    <!-- Google Fonts - Inter for UI -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Leaflet CSS (OpenStreetMap) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/main.css?v=20250103">
    <link rel="stylesheet" href="css/form.css?v=20250103">
    <link rel="stylesheet" href="css/geocoding-map.css?v=1762324026">
    <link rel="stylesheet" href="css/geocoding-map-modern.css?v=20251106">
    <link rel="stylesheet" href="css/search-history.css?v=20251106">
    <!-- POI nearby CSS removed -->
    <link rel="stylesheet" href="css/property-marker-3d.css?v=20251106">
    <link rel="stylesheet" href="css/saved-markers.css?v=20251106">
    <link rel="stylesheet" href="css/tagged-properties-panel.css?v=20251107">

    <style>
        /* Additional inline styles for enhanced visual hierarchy */
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #f5f5f5;
        }

        ::-webkit-scrollbar-thumb {
            background: #d4d4d4;
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a3a3a3;
        }
    </style>
</head>
<body class="bg-white text-neutral-900">
    <!-- Header -->
    <header class="bg-white border-b border-neutral-200 sticky top-0 z-50 backdrop-blur-sm bg-white/95">
        <div class="max-w-7xl mx-auto px-6 py-8">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-3">
                    <div class="h-10 w-10 rounded-xl bg-gradient-to-br from-indigo-500 to-indigo-600 flex items-center justify-center">
                        <i class="fas fa-map-marked-alt text-white text-lg"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-neutral-900">Geocodificación de Direcciones</h1>
                        <p class="text-sm text-neutral-600 mt-0.5">Obtén coordenadas precisas para tus propiedades</p>
                    </div>
                </div>
                <span class="hidden sm:inline-flex items-center gap-2 px-3 py-1.5 bg-emerald-50 text-emerald-700 rounded-full text-xs font-semibold border border-emerald-200">
                    <span class="h-1.5 w-1.5 rounded-full bg-emerald-500 animate-pulse"></span>
                    Servicio Activo
                </span>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <main class="max-w-7xl mx-auto px-6 py-8 space-y-6">
        <!-- Grid Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <!-- Left Panel: Form -->
            <div class="lg:col-span-5">
                <div class="bg-white rounded-2xl shadow-sm border border-neutral-200 overflow-hidden">
                    <div class="bg-gradient-to-r from-indigo-50 to-indigo-100/50 px-6 py-4 border-b border-indigo-200">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-map-marker-alt text-indigo-600 text-xl"></i>
                            <h2 class="text-lg font-semibold text-neutral-900">Ingresa la Dirección</h2>
                        </div>
                    </div>

            <form id="geocoding-form" class="p-6 space-y-5">
                <!-- Estado y Municipio -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="state" class="block text-sm font-medium text-neutral-700 mb-1.5">Estado *</label>
                        <select id="state" name="state" class="w-full rounded-xl border border-neutral-300 px-3 py-2.5 text-neutral-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all" required aria-required="true" aria-describedby="err-state">
                            <option value="">Selecciona un estado</option>
                            <option value="sinaloa" selected>Sinaloa</option>
                            <option value="nuevo-leon">Nuevo León</option>
                        </select>
                        <p id="err-state" class="mt-1 text-xs text-red-600 hidden" role="alert"></p>
                    </div>

                    <div>
                        <label for="municipality" class="block text-sm font-medium text-neutral-700 mb-1.5">Municipio *</label>
                        <select id="municipality" name="municipality" class="w-full rounded-xl border border-neutral-300 px-3 py-2.5 text-neutral-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all disabled:bg-neutral-100 disabled:cursor-not-allowed" required disabled aria-required="true" aria-describedby="err-municipality">
                            <option value="">Ej. Culiacán</option>
                        </select>
                        <p id="err-municipality" class="mt-1 text-xs text-red-600 hidden" role="alert"></p>
                    </div>
                </div>

                <!-- Colonia -->
                <div class="form-group autocomplete-wrapper">
                    <label for="colonia" class="block text-sm font-medium text-neutral-700 mb-1.5">Colonia o Fraccionamiento *</label>
                    <input
                        type="text"
                        id="colonia"
                        name="colonia"
                        class="w-full rounded-xl border border-neutral-300 px-3 py-2.5 text-neutral-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all"
                        placeholder="Ej. Las Quintas"
                        autocomplete="off"
                        required
                        aria-required="true"
                        aria-describedby="err-colonia"
                    >
                    <input type="hidden" id="colonia-value" name="coloniaSlug">
                    <div class="autocomplete-suggestions" id="colonia-suggestions"></div>
                    <p id="err-colonia" class="mt-1 text-xs text-red-600 hidden" role="alert"></p>
                </div>

                <!-- Calle -->
                <div class="form-group autocomplete-wrapper">
                    <label for="address" class="block text-sm font-medium text-neutral-700 mb-1.5">Calle *</label>
                    <input
                        type="text"
                        id="address"
                        name="address"
                        class="w-full rounded-xl border border-neutral-300 px-3 py-2.5 text-neutral-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all"
                        placeholder="Ej. Blvd. Doctor Mora"
                        autocomplete="off"
                        required
                        aria-required="true"
                        aria-describedby="err-address"
                    >
                    <div class="autocomplete-suggestions" id="address-suggestions"></div>
                    <p id="err-address" class="mt-1 text-xs text-red-600 hidden" role="alert"></p>
                </div>

                <!-- Números -->
                <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                    <div>
                        <label for="exterior-number" class="block text-sm font-medium text-neutral-700 mb-1.5">Número Exterior *</label>
                        <input
                            type="text"
                            id="exterior-number"
                            name="exteriorNumber"
                            class="w-full rounded-xl border border-neutral-300 px-3 py-2.5 text-neutral-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all"
                            placeholder="Ej: 1640"
                            required
                            aria-required="true"
                            aria-describedby="err-exterior-number"
                        >
                        <p id="err-exterior-number" class="mt-1 text-xs text-red-600 hidden" role="alert"></p>
                    </div>

                    <div>
                        <label for="interior-number" class="block text-sm font-medium text-neutral-700 mb-1.5">Número Interior</label>
                        <input
                            type="text"
                            id="interior-number"
                            name="interiorNumber"
                            class="w-full rounded-xl border border-neutral-300 px-3 py-2.5 text-neutral-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all"
                            placeholder="Opcional"
                        >
                    </div>

                    <div>
                        <label for="zip-code" class="block text-sm font-medium text-neutral-700 mb-1.5">Código Postal *</label>
                        <input
                            type="text"
                            id="zip-code"
                            name="zipCode"
                            inputmode="numeric"
                            pattern="\d{5}"
                            class="w-full rounded-xl border border-neutral-300 px-3 py-2.5 text-neutral-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all"
                            placeholder="80060"
                            maxlength="5"
                            required
                            aria-required="true"
                            aria-describedby="err-zip-code"
                        >
                        <p id="err-zip-code" class="mt-1 text-xs text-red-600 hidden" role="alert"></p>
                    </div>
                </div>

                <!-- Buttons -->
                <div class="flex gap-3 pt-4 border-t border-neutral-200">
                    <button type="submit" id="btn-geocode" class="flex-1 inline-flex items-center justify-center gap-2 rounded-xl bg-indigo-600 px-4 py-3 text-sm font-semibold text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 active:bg-indigo-800 transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-indigo-600" aria-label="Geocodificar dirección introducida" disabled>
                        <i class="fas fa-search-location"></i>
                        Geocodificar
                    </button>
                    <button type="button" id="clear-form" class="inline-flex items-center justify-center gap-2 rounded-xl border border-neutral-300 px-4 py-3 text-sm font-medium text-neutral-700 hover:bg-neutral-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 active:bg-neutral-100 transition-all" aria-label="Limpiar todos los campos">
                        <i class="fas fa-eraser"></i>
                        Limpiar
                    </button>
                </div>
            </form>

            <!-- Search History Panel -->
            <div id="history-panel" class="mt-6"></div>

            <!-- POI Nearby Panel removed -->

            <!-- Marker Management Panel -->
            <div id="marker-management-panel" class="mt-6" style="display: none;"></div>

            <!-- Results Panel -->
            <div id="results-panel" class="mt-6 bg-emerald-50 rounded-2xl border-2 border-emerald-200 overflow-hidden" style="display: none;">
                <div class="bg-emerald-500 px-6 py-4">
                    <div class="flex items-center gap-3 text-white">
                        <div class="h-10 w-10 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm">
                            <i class="fas fa-check-circle text-lg"></i>
                        </div>
                        <h3 class="text-lg font-semibold">Resultados de Geocodificación</h3>
                    </div>
                </div>

                <div class="p-6 space-y-4">
                    <div class="bg-white rounded-xl p-4 border border-emerald-200">
                        <span class="text-xs font-semibold text-emerald-700 uppercase tracking-wide">Dirección Completa</span>
                        <p class="mt-1 text-sm text-neutral-900 font-medium" id="result-address">-</p>
                    </div>

                    <!-- Información de Negociación -->
                    <div id="result-negotiation-section" class="bg-gradient-to-br from-purple-50 to-indigo-50 rounded-xl p-4 border-2 border-purple-200" style="display: none;">
                        <div class="flex items-center gap-2 mb-3">
                            <i class="fas fa-handshake text-purple-600"></i>
                            <span class="text-xs font-semibold text-purple-700 uppercase tracking-wide">Información de Negociación</span>
                        </div>

                        <div class="space-y-2">
                            <div id="result-contact-container" style="display: none;">
                                <p class="text-sm text-neutral-700">
                                    <i class="fas fa-user text-purple-600 mr-2"></i>
                                    <strong>Contacto:</strong> <span id="result-contact">-</span>
                                </p>
                            </div>
                            <div id="result-estimated-value-container" style="display: none;">
                                <p class="text-sm text-neutral-700">
                                    <i class="fas fa-dollar-sign text-green-600 mr-2"></i>
                                    <strong>Valor Estimado:</strong> <span id="result-estimated-value">-</span>
                                </p>
                            </div>
                            <div id="result-offer-container" style="display: none;">
                                <p class="text-sm text-neutral-700">
                                    <i class="fas fa-hand-holding-usd text-orange-600 mr-2"></i>
                                    <strong>Oferta Realizada:</strong> <span id="result-offer">-</span>
                                </p>
                            </div>
                            <div id="result-tag-container" style="display: none;">
                                <p class="text-sm">
                                    <i class="fas fa-tag text-purple-600 mr-2"></i>
                                    <strong>Etiqueta:</strong> <span id="result-tag-badge" class="inline-block px-3 py-1 rounded-full text-xs font-semibold">-</span>
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <div class="bg-white rounded-xl p-4 border border-emerald-200">
                            <span class="text-xs font-semibold text-emerald-700 uppercase tracking-wide">Latitud</span>
                            <code class="block mt-1 text-sm text-neutral-900 font-mono font-bold" id="result-lat">-</code>
                        </div>

                        <div class="bg-white rounded-xl p-4 border border-emerald-200">
                            <span class="text-xs font-semibold text-emerald-700 uppercase tracking-wide">Longitud</span>
                            <code class="block mt-1 text-sm text-neutral-900 font-mono font-bold" id="result-lng">-</code>
                        </div>

                        <div class="bg-white rounded-xl p-4 border border-emerald-200">
                            <span class="text-xs font-semibold text-emerald-700 uppercase tracking-wide">Código Postal</span>
                            <p class="mt-1 text-sm text-neutral-900 font-medium" id="result-zip">-</p>
                        </div>

                        <div class="bg-white rounded-xl p-4 border border-emerald-200">
                            <span class="text-xs font-semibold text-emerald-700 uppercase tracking-wide">Precisión</span>
                            <p class="mt-1 text-sm text-neutral-900 font-medium" id="result-accuracy">-</p>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl p-4 border border-emerald-200">
                        <span class="text-xs font-semibold text-emerald-700 uppercase tracking-wide">Servicio Usado</span>
                        <p class="mt-1 text-sm text-neutral-900 font-medium" id="result-service">-</p>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex flex-col gap-3 pt-2">
                        <!-- Primera fila: Google Maps + Copiar Coords -->
                        <div class="flex gap-3">
                            <a id="open-in-maps" href="#" target="_blank" class="flex-1 inline-flex items-center justify-center gap-2 rounded-xl bg-blue-600 px-4 py-3 text-sm font-semibold text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 active:bg-blue-800 transition-all">
                                <i class="fab fa-google"></i>
                                Google Maps
                            </a>

                            <button id="copy-coords" class="flex-1 inline-flex items-center justify-center gap-2 rounded-xl bg-emerald-600 px-4 py-3 text-sm font-semibold text-white hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 active:bg-emerald-800 transition-all" aria-label="Copiar coordenadas al portapapeles">
                                <i class="fas fa-copy"></i>
                                Copiar Coords
                            </button>
                        </div>

                        <!-- Segunda fila: Copiar Enlace (Deep-link) -->
                        <button id="btn-share-link" class="w-full inline-flex items-center justify-center gap-2 rounded-xl border-2 border-indigo-600 bg-white px-4 py-3 text-sm font-semibold text-indigo-600 hover:bg-indigo-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 active:bg-indigo-100 transition-all" aria-label="Copiar enlace para compartir esta ubicación">
                            <i class="fas fa-share-alt"></i>
                            Copiar Enlace para Compartir
                        </button>
                    </div>
                </div>
            </div>
                </div>
        </div>

        <!-- Right Panel: Map -->
        <div class="lg:col-span-7">
            <div class="bg-white rounded-2xl shadow-sm border border-neutral-200 overflow-hidden">
                <div class="bg-gradient-to-r from-indigo-50 to-indigo-100/50 px-6 py-4 border-b border-indigo-200">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-map text-indigo-600 text-xl"></i>
                        <h2 class="text-lg font-semibold text-neutral-900">Mapa Interactivo</h2>
                    </div>
                </div>

                <!-- Mapa con overlay card -->
                <div class="relative">
                    <div id="map" class="w-full h-[520px] rounded-b-2xl" role="application" aria-label="Mapa interactivo de geocodificación"></div>

                    <!-- Tarjeta fija sobre el mapa -->
                    <div id="loc-card" class="pointer-events-auto absolute bottom-4 left-4 w-[340px] max-w-[92vw] rounded-2xl bg-white/95 backdrop-blur shadow-xl border border-neutral-200 p-4 space-y-3" style="display: none;">
                        <div class="flex items-start gap-2">
                            <div class="mt-0.5 h-2.5 w-2.5 rounded-full bg-emerald-500"></div>
                            <div class="flex-1">
                                <h3 class="text-sm font-semibold text-neutral-900">Ubicación encontrada</h3>
                                <p id="addr" class="text-sm text-neutral-700">Av. Doctor Mora 1640, Las Quintas, Culiacán</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 gap-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-neutral-500">Coordenadas (dec)</span>
                                <code id="coords-dec" class="font-mono text-neutral-800">24.814841, -107.369199</code>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-neutral-500">Coordenadas (DMS)</span>
                                <code id="coords-dms" class="font-mono text-neutral-800">24°48'53.4"N, 107°22'09.1"W</code>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-neutral-500">CP</span>
                                <span id="cp" class="text-neutral-800">80060</span>
                            </div>
                        </div>

                        <div class="flex items-center gap-2">
                            <button id="btn-copy" class="inline-flex items-center justify-center rounded-xl border border-neutral-300 px-3 py-2 text-sm font-medium hover:bg-neutral-50 active:bg-neutral-100 transition-all">
                                Copiar coords
                            </button>
                            <button id="btn-use" class="inline-flex items-center justify-center rounded-xl bg-indigo-600 px-3 py-2 text-sm font-semibold text-white hover:bg-indigo-700 active:bg-indigo-800 transition-all">
                                Usar ubicación
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Legend -->
                <div class="bg-neutral-50 px-6 py-3 border-t border-neutral-200 flex flex-wrap gap-4 justify-center text-sm text-neutral-600">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-map-pin text-indigo-600"></i>
                        <span>Ubicación geocodificada</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <i class="fas fa-hand-pointer text-indigo-600"></i>
                        <span>Arrastra el marcador para ajustar</span>
                    </div>
                </div>
            </div>
        </div>
        </div>
    </main>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center" style="display: none;">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-sm mx-4">
            <div class="flex flex-col items-center space-y-4">
                <div class="h-16 w-16 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin"></div>
                <div class="text-center">
                    <p class="text-lg font-semibold text-neutral-900">Geocodificando dirección...</p>
                    <p class="text-sm text-neutral-600 mt-1">Esto puede tomar unos segundos</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container" class="fixed top-6 right-6 z-50 flex flex-col gap-3 max-w-md"></div>

    <!-- Botón flotante para abrir panel de propiedades etiquetadas -->
    <button id="toggle-tagged-panel">
        <i class="fas fa-tags"></i>
        <span>Propiedades</span>
        <span class="count-badge" id="tagged-count">0</span>
    </button>

    <!-- Panel lateral de propiedades etiquetadas -->
    <div id="tagged-properties-sidebar">
        <div class="tagged-panel-header">
            <h3>
                <i class="fas fa-tags"></i>
                Propiedades Etiquetadas
                <span class="count-badge" id="tagged-count-header">0</span>
            </h3>
            <button class="close-panel-btn" id="close-tagged-panel">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="tagged-panel-content" id="tagged-panel-content">
            <!-- Se llenará dinámicamente con JS -->
        </div>
    </div>

    <!-- Modal de edición -->
    <div class="edit-modal-overlay" id="edit-modal-overlay">
        <div class="edit-modal">
            <div class="edit-modal-header">
                <h3>
                    <i class="fas fa-edit"></i>
                    Editar Propiedad
                </h3>
                <button class="edit-modal-close" id="edit-modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="edit-modal-body" id="edit-modal-body">
                <!-- Se llenará dinámicamente con JS -->
            </div>
            <div class="edit-modal-footer">
                <button class="edit-modal-btn edit-modal-btn-cancel" id="edit-modal-cancel">
                    Cancelar
                </button>
                <button class="edit-modal-btn edit-modal-btn-save" id="edit-modal-save">
                    <i class="fas fa-save"></i>
                    Guardar Cambios
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>

    <!-- Custom Scripts -->
    <script src="js/autocomplete.js?v=1762320897"></script>
    <script src="js/geocoding.js?v=1762482560"></script>
    <script src="js/validation.js?v=1762482118"></script>
    <script src="js/marker-manager.js?v=20251106"></script>
    <script src="js/search-history.js?v=20251106"></script>
    <!-- POI nearby JS removed -->
    <script src="js/geocoding-map.js?v=1762482118"></script>
    <script src="js/deep-link.js?v=1762482118"></script>
</body>
</html>
