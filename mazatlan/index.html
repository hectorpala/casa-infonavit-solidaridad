<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>üîß STAGING - Mazatl√°n Map Explorer | Hector es Bienes Ra√≠ces</title>

    <!-- Google Fonts: Poppins + Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
/* ===============================
   DESIGN TOKENS - HECTOR COLORS
================================= */
:root{
  /* Brand & accents - Hector Orange */
  --primary: #FF6A00;
  --primary-dark: #D35500;
  --hector: #FF6A00;
  --hector-dark: #D35500;
  --green: #22C55E;
  --green-600:#059669;
  --amber:#F59E0B;
  --blue:#3B82F6;
  --teal: #0EA5A6;

  /* Tokens para m√≥vil (din√°micos - JS los actualiza) */
  --top-stack: 56px;
  --sheet-min: 320px;
  --sheet-fixed: 38dvh;   /* altura fija compacta del sheet (1 card completa) */
  --map-min-dvh: 58dvh;   /* objetivo: mapa ‚â•58% del viewport */
  --sheet-max-dvh: 42dvh; /* el sheet ocupa el resto (1 card completa) */

  /* Neutrals */
  --ink:#0F172A;
  --ink-2:#334155;
  --ink-3:#64748B;
  --bg:#F8FAFC;
  --bg-alt:#121A2D;
  --panel:#F9FAFB;
  --line:#E5E7EB;
  --line-2:#E2E8F0;
  --white:#FFFFFF;
  --text-muted: #94A3B8;

  /* Elevation */
  --shadow-s: 0 1px 2px rgba(15,23,42,.06), 0 1px 1px rgba(15,23,42,.04);
  --shadow-m: 0 6px 16px rgba(15,23,42,.08), 0 2px 6px rgba(15,23,42,.06);
  --shadow-l: 0 12px 32px rgba(15,23,42,.12), 0 6px 12px rgba(15,23,42,.06);
  --shadow-focus: 0 0 0 3px rgba(14,165,166,.28);

  /* Radius & spacing */
  --r-6: 6px;
  --r-8: 8px;
  --r-10: 10px;
  --r-12: 12px;
  --r-16: 16px;

  /* Sizing */
  --list-width: 480px;

  /* Transitions */
  --t-fast: 140ms;
  --t-med: 220ms;
  --t-slow: 360ms;

  /* Gradients - Hector Orange */
  --g-primary: linear-gradient(135deg, #FF6A00 0%, #D35500 100%);
  --g-green: linear-gradient(135deg, #22C55E 0%, #059669 100%);
  --g-ink: linear-gradient(180deg, rgba(15,23,42,.0), rgba(15,23,42,.35));

  /* Marker tiers (rango de precio) */
  --mk-low: #22C55E;   /* < $3.0M - Verde */
  --mk-mid: #0EA5A6;   /* $3.0M‚Äì$5.0M - Teal */
  --mk-high: #3B82F6;  /* > $5.0M - Azul */
}

/* Reset m√≠nimo para consistencia visual */
* { box-sizing: border-box; }
html, body { height: 100%; margin: 0; }
body{
  background: var(--bg);
  color: var(--ink);
  font-family: 'Poppins', 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  -webkit-font-smoothing: antialiased;
  text-rendering: optimizeLegibility;
  overflow: hidden;
}

/* ===============================
   STAGING BANNER
================================= */
.staging-banner{
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
  color: #FFF;
  border-bottom: 0;
  font-weight: 700;
  letter-spacing:.2px;
  padding:10px 16px;
  text-align:center;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 1000;
}

/* ===============================
   HEADER (sticky)
================================= */
.header-bar{
  position: fixed;
  top: 44px;
  left: 0;
  right: 0;
  z-index: 999;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:14px 18px;
  background: var(--white);
  border-bottom:1px solid var(--line-2);
  box-shadow: 0 0 0 1px rgba(14,165,166,.06);
  backdrop-filter: saturate(1.2) blur(6px);
}
.header-title{
  font-weight: 800;
  font-size: clamp(18px, 2.2vw, 22px);
  color: var(--ink);
}
.header-title span{
  font-weight:600;
  color: var(--ink-3);
  background: rgba(255,106,0,.08);
  border:1px solid rgba(255,106,0,.18);
  padding:2px 8px;
  border-radius:999px;
  margin-left:6px;
  font-size: 14px;
}
.header-stats p{
  margin:0;
  font-weight:700;
  color: var(--ink);
}
.header-stats small{
  display:block;
  color: var(--ink-3);
  margin-top:2px;
}

/* ===============================
   FILTER BAR (sticky)
================================= */
.filter-bar{
  position: fixed;
  top: 104px;
  left: 0;
  right: 0;
  z-index: 998;
  display:flex;
  align-items:center;
  gap:10px;
  background: var(--white);
  padding:10px 16px;
  border-bottom:1px solid var(--line-2);
}
.filter-bar select,
.filter-bar button{
  height:36px;
  border-radius: 999px;
  border:1px solid var(--line);
  background: var(--white);
  padding: 0 36px 0 12px;
  font-weight:600;
  color: var(--ink-2);
  box-shadow: var(--shadow-s);
  transition: border-color var(--t-fast) ease, box-shadow var(--t-fast) ease, transform var(--t-fast) ease;
  appearance:none;
  -webkit-appearance:none;
  -moz-appearance:none;
  background-image: url("data:image/svg+xml,%3Csvg width='16' height='16' viewBox='0 0 20 20' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M6 8l4 4 4-4' stroke='%2364748B' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
  background-repeat:no-repeat;
  background-position:right 12px center;
  font-family: 'Inter', sans-serif;
  cursor: pointer;
}
.filter-bar select:focus,
.filter-bar button:focus{
  outline:none;
  box-shadow: var(--shadow-focus);
  border-color: rgba(14,165,166,.6);
}
.filter-bar select:hover{
  transform: translateY(-1px);
}
.filter-bar button{
  background: linear-gradient(#fff, #fff) padding-box, linear-gradient(135deg, rgba(14,165,166,.45), rgba(59,130,246,.45)) border-box;
  border: 1px solid transparent;
  color: var(--ink-2);
  padding: 0 16px;
}
.filter-bar button:hover{
  transform: translateY(-1px);
}
.filter-bar button:active{
  transform: translateY(0);
}
.results-counter{
  margin-left:auto;
  padding:6px 12px;
  border-radius:999px;
  background: #EEF9F6;
  color: #0B664E;
  border:1px solid #B6E6D9;
  font-weight:700;
  font-size: 13px;
}

/* ===============================
   LAYOUT (map + list)
================================= */
.main-container{
  display:flex;
  position: fixed;
  top: 176px;
  left: 0;
  right: 0;
  bottom: 0;
}
.map-section{
  flex: 1 1 auto;
  height: 100%;
}
#map-container{
  width:100%;
  height:100%;
  border-right:1px solid var(--line-2);
}
.listings-section{
  width: var(--list-width);
  flex: 0 0 var(--list-width);
  height: 100%; /* Asegurar altura para scroll */
  background: var(--panel);
  border-left:1px solid var(--line);
  padding: 10px;
  overflow-y: auto; /* Scroll vertical expl√≠cito */
  overflow-x: hidden; /* Sin scroll horizontal */
  scrollbar-width: thin;
  scrollbar-color: rgba(2,6,23,.25) transparent;
}
.listings-section::-webkit-scrollbar{
  width:10px;
}
.listings-section::-webkit-scrollbar-thumb{
  background: rgba(2,6,23,.18);
  border-radius:999px;
}

/* ===============================
   LISTING CARD
================================= */
.listing-card{
  background: var(--white);
  border:1px solid var(--line);
  border-radius: var(--r-12);
  overflow:hidden;
  box-shadow: var(--shadow-s);
  transition: transform var(--t-med) cubic-bezier(.2,.7,.2,1), box-shadow var(--t-med), border-color var(--t-med);
  will-change: transform;
  margin-bottom:12px;
  cursor: pointer;
  position: relative;
}
.listing-card:hover{
  transform: translateY(-8px) scale(1.05);
  box-shadow: var(--shadow-l), 0 0 0 4px var(--primary);
  border-color: var(--primary);
  animation: heartbeat 6s ease-in-out;
  z-index: 100;
}
.listing-card.highlighted{
  border-color: var(--primary);
  box-shadow: 0 8px 24px rgba(255,106,0,.28), 0 2px 12px rgba(255,106,0,.18), 0 0 0 4px var(--primary);
  animation: heartbeat 6s ease-in-out;
  z-index: 100;
}

/* Animaci√≥n de latidos de coraz√≥n */
@keyframes heartbeat {
  0%, 100% { transform: translateY(-8px) scale(1.05); }
  10% { transform: translateY(-8px) scale(1.07); }
  20% { transform: translateY(-8px) scale(1.05); }
  30% { transform: translateY(-8px) scale(1.07); }
  40%, 60% { transform: translateY(-8px) scale(1.05); }
}

/* Carrusel de fotos en tarjetas */
.card-carousel-container {
  position: relative;
  overflow: hidden;
}
.card-carousel-images {
  display: flex;
  transition: transform 0.4s ease-in-out;
}
.card-carousel-images img {
  flex-shrink: 0;
  width: 100%;
}
.carousel-arrow-card {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  width: 32px;
  height: 32px;
  background: rgba(255,106,0,0.9);
  border: 1px solid rgba(255,106,0,0.5);
  border-radius: 50%;
  display: grid;
  place-items: center;
  cursor: pointer;
  transition: all 0.2s;
  z-index: 20;
  opacity: 0;
  color: white;
}
.listing-card:hover .carousel-arrow-card {
  opacity: 1;
}
.carousel-arrow-card:hover {
  background: var(--primary);
  transform: translateY(-50%) scale(1.1);
}
.carousel-arrow-card.prev {
  left: 8px;
}
.carousel-arrow-card.next {
  right: 8px;
}
.carousel-dots {
  position: absolute;
  bottom: 8px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 6px;
  z-index: 15;
}
.carousel-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: rgba(255,255,255,0.5);
  cursor: pointer;
  transition: all 0.2s;
}
.carousel-dot.active {
  background: white;
  width: 20px;
  border-radius: 3px;
}

/* Imagen con aspecto consistente */
.listing-card .listing-image{
  display:block;
  width:100%;
  aspect-ratio: 16/10;
  object-fit: cover;
  background: #E5E7EB;
  transform: translateZ(0);
  transition: filter var(--t-med) ease;
}
.listing-card:hover .listing-image{
  filter: saturate(1.04) contrast(1.02);
}

/* Overlay suave para legibilidad sobre fotos claras */
.listing-card .media-overlay{
  position:absolute;
  inset:0;
  pointer-events:none;
  background: var(--g-ink);
}

/* Price badge (glass + gradiente) */
.price-badge{
  position:absolute;
  left:12px;
  bottom:12px;
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:8px 12px;
  border-radius: 10px;
  color:#fff;
  font-weight:800;
  letter-spacing:.2px;
  background: var(--g-green);
  box-shadow: 0 6px 18px rgba(16,185,129,.45);
  border:1px solid rgba(255,255,255,.18);
  backdrop-filter: saturate(1.2) blur(8px);
}
.price-badge small{
  font-weight:700;
  opacity:.9;
}

/* Action corner (opcional: favorito / compartir) */
.card-actions{
  position:absolute;
  right:10px;
  top:10px;
  display:flex;
  gap:8px;
  z-index: 10;
}
.icon-btn{
  width:34px;
  height:34px;
  display:grid;
  place-items:center;
  border-radius:999px;
  background: rgba(255,255,255,.85);
  border:1px solid rgba(14,165,166,.25);
  box-shadow: var(--shadow-s);
  transition: transform var(--t-fast), background var(--t-fast);
  cursor: pointer;
  color: var(--ink-3);
}
.icon-btn:hover{
  transform: translateY(-1px);
  background:#fff;
  color: var(--primary);
}

/* Body */
.listing-card .content{
  padding:14px 16px 16px;
}
.listing-card h3{
  margin:0 0 6px;
  font-weight:800;
  font-size: clamp(16px, 2vw, 18px);
  color: var(--ink);
}
.listing-card p{
  margin:0;
  color: var(--ink-2);
  font-size: 14px;
}
.listing-meta{
  display:flex;
  align-items:center;
  gap:14px;
  margin-top:8px;
  color: var(--ink-2);
  font-weight:600;
  font-size: 13px;
}
.listing-meta .dot{
  width:4px;
  height:4px;
  border-radius:999px;
  background: var(--line-2);
}

/* Badges informativas */
.badges{
  margin-top:10px;
  display:flex;
  flex-wrap:wrap;
  gap:8px;
}
.badge{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:6px 10px;
  border-radius:999px;
  background:#EEF2FF;
  color:#3730A3;
  border:1px solid #C7D2FE;
  font-weight:700;
  font-size:12px;
}
.badge.teal{
  background:#ECFEFF;
  color:#0F766E;
  border-color:#A5F3FC;
}
.badge.green{
  background:#ECFDF5;
  color:#065F46;
  border-color:#A7F3D0;
}
.badge.amber{
  background:#FFF4ED;
  color:#D35500;
  border-color:#FFCBA4;
}
.badge.blue{
  background:#EFF6FF;
  color:#1E40AF;
  border-color:#BFDBFE;
}

/* ===============================
   NO RESULTS
================================= */
.no-results {
  text-align: center;
  padding: 60px 20px;
}
.no-results p {
  color: var(--ink-3);
  font-size: 18px;
  margin-bottom: 16px;
}
.no-results button {
  padding: 10px 24px;
  background: var(--green);
  color: white;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  font-family: 'Inter', sans-serif;
  transition: background var(--t-fast);
}
.no-results button:hover {
  background: var(--green-600);
}

/* ===============================
   ACCESSIBILITY & MOTION
================================= */
@media (prefers-reduced-motion: reduce){
  *{ transition: none !important; animation: none !important; }
}

/* ===============================
   ANTI-JITTER SYSTEM
================================= */
/* Bloqueo temporal de animaciones del sheet durante animaci√≥n del mapa */
body.map-animating .listings-section {
  transition: none !important;
}
body.map-animating .listing-card .listing-image {
  transition: none !important;
}

/* ===============================
   RESPONSIVE M√ìVIL
================================= */
/* ===== Stack superior flotante (m√≥vil) ===== */
@media (max-width: 768px) {
  body { overflow: hidden; }
  .main-container { display: block; }

  /* Banner STAGING compacto y fijo */
  .staging-banner {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 50;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 8px;
    font-size: 12px;
    font-weight: 800;
    border-bottom: 0;
  }

  /* Header sticky bajo el banner */
  .header-bar {
    position: fixed;
    top: 28px;
    left: 0;
    right: 0;
    z-index: 45;
    padding: 10px 14px;
    border-bottom: 1px solid rgba(226,232,240,.9);
    background: rgba(255,255,255,.96);
    backdrop-filter: blur(8px);
  }

  /* Filtros flotantes sobre el mapa */
  .filter-bar {
    position: fixed;
    top: calc(var(--top-stack) + 8px);
    left: 8px;
    right: 8px;
    z-index: 40;
    height: 42px;
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 8px;
    background: rgba(255,255,255,.9);
    border: 1px solid rgba(226,232,240,.9);
    border-radius: 999px;
    box-shadow: 0 6px 18px rgba(2,6,23,.10);
    white-space: nowrap;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
  }

  .filter-bar::-webkit-scrollbar { display: none; }

  .filter-bar select,
  .filter-bar button {
    height: 32px;
    padding: 0 28px 0 10px;
    font-size: 13px;
    font-weight: 700;
    border-radius: 999px;
  }

  /* Mapa inicia bajo el stack superior - MAP-FIRST: SIEMPRE ‚â•60dvh */
  .map-section {
    position: fixed;
    top: var(--top-stack);
    left: 0;
    right: 0;
    height: max(
      var(--map-min-dvh),
      calc(100dvh - var(--top-stack) - var(--sheet-min) - env(safe-area-inset-bottom))
    );
    z-index: 1;
    background: #e5f2ff;
  }

  #map-container { height: 100%; }

  /* Bottom sheet - MAP-FIRST: limitado a 40dvh m√°ximo */
  .listings-panel {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    width: 100%;
    height: min(var(--sheet-min), var(--sheet-max-dvh));
    max-height: calc(100dvh - var(--top-stack));
    background: var(--panel, #F9FAFB);
    border-top-left-radius: 16px;
    border-top-right-radius: 16px;
    box-shadow: 0 -8px 24px rgba(2,6,23,.12);
    z-index: 2;
    overflow: hidden;
  }

  .listings-section {
    height: 100%;
    padding: 10px 10px calc(12px + env(safe-area-inset-bottom));
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    scroll-snap-type: y mandatory;
    scroll-padding-top: 10px;
    scroll-padding-bottom: calc(16px + env(safe-area-inset-bottom));
  }

  .listings-section::before {
    content: "";
    display: block;
    width: 40px;
    height: 4px;
    border-radius: 999px;
    background: #CBD5E1;
    margin: 8px auto 10px;
  }

  .listing-card {
    scroll-snap-align: start;
    margin-bottom: 12px;
  }

  /* ===== TARJETA COMPACTA FIJA (m√≥vil) ===== */
  /* FIX: Primera tarjeta visible sin espacios fantasma */
  .listings-section {
    height: var(--sheet-fixed, 36dvh) !important;
    max-height: var(--sheet-fixed, 36dvh) !important;
    padding-top: 8px !important;
    padding-bottom: 0 !important; /* Sin padding inferior para evitar espacio blanco */
    overflow-y: auto !important;
    scroll-snap-type: y mandatory;
    scroll-padding-top: 8px; /* ayuda al encaje del primer card */
  }

  /* Elimina m√°rgenes fantasma en el primer √≠tem */
  .listings-section > .listing-card:first-child {
    margin-top: 0 !important;
  }

  /* Por si tu inyecci√≥n agrega separadores/sentinels/espaciadores arriba */
  .listings-section .spacer,
  .listings-section .sentinel,
  .listings-section .drag-handle,
  .listings-section .header-shadow {
    display: none !important;
  }

  /* Quita el "handle" para que no sugiera expansi√≥n */
  .listings-section::before {
    display: none !important;
  }

  /* La card no se eleva ni cambia tama√±o al tocar */
  .listing-card {
    transition: none !important;
    margin-bottom: 4px !important;
    border: none !important; /* Eliminar border para ganar espacio */
  }
  .listing-card:hover,
  .listing-card:active {
    transform: none !important;
    box-shadow: var(--shadow-s, 0 1px 2px rgba(0,0,0,.06)) !important;
  }

  /* Primera tarjeta es la √∫nica visible - sin margen extra en √∫ltima */
  .listing-card:last-child {
    margin-bottom: 4px !important;
  }

  /* Asegurar que content sea visible */
  .listing-card .content {
    display: block !important;
    padding: 5px 5px 5px !important; /* Padding ultra-m√≠nimo - 5px en vez de 6px */
  }

  /* Tarjeta compacta: foto + t√≠tulo (1 l√≠nea) + meta (1 l√≠nea) */
  .listing-card .description,
  .listing-card .headline,
  .listing-card .badges,
  .listing-card .cta-row,
  .listing-card .sheet-cutoff-anchor {
    display: none !important;
  }

  /* Imagen con altura ajustada +2.5cm (~95px) */
  .listing-card .listing-image {
    aspect-ratio: 2/1 !important; /* M√°s panor√°mica/chata */
    object-fit: cover;
    height: auto !important;
    max-height: 215px !important; /* Aumentado a 215px (+95px ‚âà 2.5cm total) */
  }

  /* T√≠tulo: 1 l√≠nea - M√ÅS GRANDE y legible */
  .listing-card h3 {
    display: -webkit-box !important;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
    font-size: 13.5px !important; /* Aumentado de 11.5px a 13.5px */
    line-height: 1.15 !important; /* Menos comprimido */
    font-weight: 700 !important; /* M√°s bold para legibilidad */
    margin: 2px 0 3px !important; /* M√°s respiro */
    letter-spacing: -0.2px !important; /* Menos compresi√≥n */
    word-spacing: -0.5px !important; /* Menos compresi√≥n */
  }

  /* Fila de iconos (deja solo una l√≠nea) - M√ÅS GRANDE */
  .listing-meta {
    display: flex !important;
    align-items: center;
    gap: 10px !important; /* Aumentado de 8px a 10px */
    margin: 0 !important;
    font-size: 13px !important; /* Aumentado de 11.5px a 13px */
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* Dots separadores normales */
  .listing-meta .dot {
    width: 3px !important;
    height: 3px !important;
  }

  /* Mapa grande: respeta map-first */
  .map-section {
    height: max(
      var(--map-min-dvh, 60dvh),
      calc(100dvh - var(--top-stack, 56px) - var(--sheet-fixed, 36dvh) - env(safe-area-inset-bottom))
    );
  }

  .listing-card .headline {
    margin: 8px 0 6px;
    color: #334155;
    font-weight: 600;
    line-height: 1.35;
    font-size: 14px;
  }

  .sheet-cutoff-anchor {
    width: 100%;
    height: 0;
    margin: 0;
    pointer-events: none;
  }

  .listing-card .description {
    color: #475569;
    margin-top: 6px;
    font-size: 14px;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
  }
}
    </style>
</head>
<body>

    <div class="staging-banner">
        üîß AMBIENTE DE PRUEBAS - NO INDEXAR - STAGING ONLY
    </div>

    <div class="header-bar">
        <div style="display: flex; align-items: center; gap: 16px;">
            <img src="../images/optimized/Logo-hector-es-bienes-raices.png"
                 alt="Hector es Bienes Ra√≠ces"
                 style="height: 40px; width: auto;">
            <div class="header-title">
                üó∫Ô∏è Mazatl√°n <span>(STAGING)</span>
            </div>
        </div>
        <div class="header-stats">
            <p><span id="visible-count">18</span> Propiedades</p>
            <small>$2.0M - $6.3M</small>
        </div>
    </div>

    <div class="filter-bar">
        <select id="filter-price">
            <option value="">Precio</option>
            <option value="0-1500000">Hasta $1.5M</option>
            <option value="1500000-2000000">$1.5M - $2.0M</option>
            <option value="2000000-2500000">$2.0M - $2.5M</option>
            <option value="2500000-3000000">$2.5M - $3.0M</option>
            <option value="3000000-3500000">$3.0M - $3.5M</option>
            <option value="3500000-4000000">$3.5M - $4.0M</option>
            <option value="4000000-999999999">M√°s de $4.0M</option>
        </select>

        <select id="filter-bedrooms">
            <option value="">Rec√°maras</option>
            <option value="2">2 Rec√°maras</option>
            <option value="3">3 Rec√°maras</option>
            <option value="4">4 Rec√°maras</option>
        </select>

        <select id="filter-zone">
            <option value="">Todas las zonas</option>
            <option value="real-del-valle">Real del Valle</option>
            <option value="marina">Zona Marina</option>
            <option value="centro">Centro</option>
            <option value="otro">Otras zonas</option>
        </select>

        <button onclick="resetFilters()">üîÑ Limpiar</button>

        <div class="results-counter">
            <span id="results-text">18 de 18 propiedades</span>
        </div>
    </div>

    <div class="main-container">
        <div class="map-section">
            <div id="map-container"></div>
        </div>

        <div class="listings-panel">
            <div class="listings-section" id="listings-container">
            </div>
        </div>
    </div>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDKzdyJP29acUNCqHr9klrz-Hz_0tIu7sk&libraries=places"></script>

    <!-- MarkerClusterer para agrupar marcadores cercanos -->
    <script src="https://unpkg.com/@googlemaps/markerclusterer@2.5.3/dist/index.min.js"></script>

    <script>
        const ALL_PROPERTIES = [
            { slug: "casa-en-venta-real-del-valle", priceShort: "$3.5M", price: 3500000, title: "Casa en Venta Real del Valle", location: "Real del Valle", bedrooms: 3, bathrooms: 2, sqft: 200, zone: "real-del-valle", image: "../mazatlan/casa-en-venta-real-del-valle/images/foto-1.jpg" },
            { slug: "casa-de-venta-en-rincon-de-los-girasoles-en-fracc-rincon-de-", priceShort: "$3.5M", price: 3500000, title: "Casa Rincon Girasoles", location: "Rincon de Las Plazas", bedrooms: 3, bathrooms: 2, sqft: 180, zone: "otro", image: "../mazatlan/casa-de-venta-en-rincon-de-los-girasoles-en-fracc-rincon-de-/images/foto-1.jpg" },
            { slug: "casa-en-venta-en-mazatlan-cercana-a-marina-mazatlan-y-playas", priceShort: "$2.6M", price: 2600000, title: "Casa Cercana a Marina", location: "Marina Mazatl√°n", bedrooms: 3, bathrooms: 2, sqft: 150, zone: "marina", image: "../mazatlan/casa-en-venta-en-mazatlan-cercana-a-marina-mazatlan-y-playas/images/foto-1.jpg" },
            { slug: "casa-en-venta-en-veredas-mazatlan-sin", priceShort: "$3.3M", price: 3300000, title: "Casa en Veredas", location: "Veredas", bedrooms: 3, bathrooms: 2, sqft: 190, zone: "otro", image: "../mazatlan/casa-en-venta-en-veredas-mazatlan-sin/images/foto-1.jpg" },
            { slug: "casa-de-3-recamaras-y-160-m-en-venta-valle-del-ejido", priceShort: "$2.3M", price: 2300000, title: "Casa Valle del Ejido", location: "Valle del Ejido", bedrooms: 3, bathrooms: 2, sqft: 160, zone: "otro", image: "../mazatlan/casa-de-3-recamaras-y-160-m-en-venta-valle-del-ejido/images/foto-1.jpg" },
            { slug: "casa-en-venta-de-real-del-valle-coto-14", priceShort: "$3.0M", price: 3000000, title: "Casa Real del Valle Coto 14", location: "Real del Valle", bedrooms: 3, bathrooms: 2, sqft: 175, zone: "real-del-valle", image: "../mazatlan/casa-en-venta-de-real-del-valle-coto-14/images/foto-1.jpg" },
            { slug: "casa-en-venta-residencial-con-alberca-en-real-del-valle-maza", priceShort: "$3.4M", price: 3400000, title: "Casa con Alberca Real del Valle", location: "Real del Valle", bedrooms: 4, bathrooms: 3, sqft: 220, zone: "real-del-valle", image: "../mazatlan/casa-en-venta-residencial-con-alberca-en-real-del-valle-maza/images/foto-1.jpg" },
            { slug: "casa-en-venta-en-el-fracc-porto-molino-mazatlan-sinaloa", priceShort: "$2.6M", price: 2600000, title: "Casa Porto Molino", location: "Porto Molino", bedrooms: 3, bathrooms: 2, sqft: 155, zone: "otro", image: "../mazatlan/casa-en-venta-en-el-fracc-porto-molino-mazatlan-sinaloa/images/foto-1.jpg" },
            { slug: "casa-113-m-con-3-recamaras-en-venta-fraccionamiento-isla-res", priceShort: "$3.2M", price: 3200000, title: "Casa Isla Residencial", location: "Isla Residencial", bedrooms: 3, bathrooms: 2, sqft: 113, zone: "otro", image: "../mazatlan/casa-113-m-con-3-recamaras-en-venta-fraccionamiento-isla-res/images/foto-1.jpg" },
            { slug: "casa-en-venta-en-mazatlan-fraccionamiento-real-pacifico", priceShort: "$2.1M", price: 2100000, title: "Casa Real Pacifico", location: "Real Pacifico", bedrooms: 3, bathrooms: 2, sqft: 140, zone: "otro", image: "../mazatlan/casa-en-venta-en-mazatlan-fraccionamiento-real-pacifico/images/foto-1.jpg" },
            { slug: "casa-en-venta-mazatlan-residencial-palmilla-super-precio", priceShort: "$3.7M", price: 3700000, title: "Casa Residencial Palmilla", location: "Residencial Palmilla", bedrooms: 3, bathrooms: 2, sqft: 200, zone: "otro", image: "../mazatlan/casa-en-venta-mazatlan-residencial-palmilla-super-precio/images/foto-1.jpg" },
            { slug: "casa-en-venta-en-privada-con-alberca-en-mazatlan", priceShort: "$3.3M", price: 3300000, title: "Casa Privada con Alberca", location: "Privada Mazatl√°n", bedrooms: 3, bathrooms: 2, sqft: 185, zone: "otro", image: "../mazatlan/casa-en-venta-en-privada-con-alberca-en-mazatlan/images/foto-1.jpg" },
            { slug: "casa-en-venta-en-mazatlan-sinaloa-villa-galaxia", priceShort: "$2.0M", price: 2000000, title: "Casa Villa Galaxia", location: "Villa Galaxia", bedrooms: 3, bathrooms: 2, sqft: 130, zone: "otro", image: "../mazatlan/casa-en-venta-en-mazatlan-sinaloa-villa-galaxia/images/foto-1.jpg" },
            { slug: "casa-en-venta-en-mazatlan-sinaloa-hacienda-del-seminario-fue", priceShort: "$2.4M", price: 2400000, title: "Casa Hacienda del Seminario", location: "Hacienda del Seminario", bedrooms: 3, bathrooms: 2, sqft: 145, zone: "otro", image: "../mazatlan/casa-en-venta-en-mazatlan-sinaloa-hacienda-del-seminario-fue/images/foto-1.jpg" },
            { slug: "casa-en-venta-en-mazatlan-en-coto-privado-camila-hills-model", priceShort: "$2.7M", price: 2700000, title: "Casa Camila Hills", location: "Av Paseo del Pac√≠fico", bedrooms: 3, bathrooms: 2, sqft: 165, zone: "otro", image: "../mazatlan/casa-en-venta-en-mazatlan-en-coto-privado-camila-hills-model/images/foto-1.jpg" },
            { slug: "casa-en-venta-en-mazatlan", priceShort: "$2.7M", price: 2700000, title: "Casa Mazatl√°n Centro", location: "Centro Mazatl√°n", bedrooms: 3, bathrooms: 2, sqft: 160, zone: "centro", image: "../mazatlan/casa-en-venta-en-mazatlan/images/foto-1.jpg" },
            { slug: "casa-en-venta-151-m-con-terraza-recamara-en-planta-baja-en-z", priceShort: "$2.4M", price: 2400000, title: "Casa De Los Peces", location: "De Los Peces", bedrooms: 3, bathrooms: 2, sqft: 151, zone: "otro", image: "../mazatlan/casa-en-venta-151-m-con-terraza-recamara-en-planta-baja-en-z/images/foto-1.jpg" },
            { slug: "casa-en-venta-en-la-primavera-barrio-san-francisco-sur-01", priceShort: "$6.3M", price: 6300000, title: "Casa Barrio San Francisco", location: "Barrio San Francisco", bedrooms: 2, bathrooms: 1, sqft: 146, zone: "centro", image: "../mazatlan/casa-en-venta-en-la-primavera-barrio-san-francisco-sur-01/images/foto-1.jpg" }
        ];

        let map, markers = {}, infoWindows = {}, clusterer = null;
        let filteredProperties = [...ALL_PROPERTIES];

        // Funci√≥n para determinar color de marcador - TODOS NARANJA HECTOR
        function getMarkerGradient(price) {
            return 'linear-gradient(135deg, #FF6A00 0%, #D35500 100%)';
        }

        function initMap() {
            map = new google.maps.Map(document.getElementById('map-container'), {
                center: { lat: 23.2494, lng: -106.4110 },
                zoom: 12,
                mapTypeControl: false,
                fullscreenControl: false,
                streetViewControl: false
            });

            renderMarkers(filteredProperties);
            renderListings(filteredProperties);
        }

        function renderMarkers(properties) {
            Object.values(markers).forEach(m => m.setMap(null));
            markers = {};
            infoWindows = {};

            const geocoder = new google.maps.Geocoder();

            properties.forEach(property => {
                geocoder.geocode({ address: property.location + ', Mazatl√°n, Sinaloa' }, function(results, status) {
                    if (status === 'OK' && results[0]) {
                        const position = results[0].geometry.location;
                        const gradient = getMarkerGradient(property.price);

                        const marker = new google.maps.Marker({
                            position: position,
                            map: map,
                            title: property.title,
                            icon: {
                                url: `data:image/svg+xml;charset=UTF-8,${encodeURIComponent(`
                                    <svg width="80" height="40" xmlns="http://www.w3.org/2000/svg">
                                        <defs>
                                            <linearGradient id="g-${property.slug.substring(0,10)}" x1="0%" y1="0%" x2="100%" y2="100%">
                                                <stop offset="0%" style="stop-color:#FF6A00;stop-opacity:1" />
                                                <stop offset="100%" style="stop-color:#D35500;stop-opacity:1" />
                                            </linearGradient>
                                        </defs>
                                        <rect x="0" y="0" width="80" height="32" rx="16" fill="url(#g-${property.slug.substring(0,10)})" stroke="white" stroke-width="3"/>
                                        <text x="40" y="21" font-family="Poppins" font-size="14" font-weight="800" fill="white" text-anchor="middle">${property.priceShort}</text>
                                    </svg>
                                `)}`,
                                scaledSize: new google.maps.Size(80, 40),
                                anchor: new google.maps.Point(40, 40)
                            }
                        });

                        const infoWindow = new google.maps.InfoWindow({
                            content: `
                                <div style="padding:0;max-width:280px;font-family:Inter,sans-serif">
                                    <img src="${property.image}" style="width:100%;height:180px;object-fit:cover;border-radius:8px 8px 0 0">
                                    <div style="padding:12px">
                                        <h4 style="margin:0 0 6px;color:#FF6A00;font-size:18px;font-weight:700">${property.priceShort}</h4>
                                        <h5 style="margin:0 0 6px;color:#1f2937;font-size:14px;font-weight:600">${property.title}</h5>
                                        <p style="margin:0 0 8px;color:#6b7280;font-size:12px">üìç ${property.location}</p>
                                        <div style="display:flex;gap:12px;margin-bottom:10px;color:#6b7280;font-size:12px">
                                            <span>üõèÔ∏è ${property.bedrooms}</span>
                                            <span>üöø ${property.bathrooms}</span>
                                            <span>üìê ${property.sqft}m¬≤</span>
                                        </div>
                                        <a href="../mazatlan/${property.slug}/index.html" target="_blank" style="display:block;background:#10b981;color:white;text-align:center;padding:8px;border-radius:6px;text-decoration:none;font-size:13px;font-weight:600">Ver Propiedad ‚Üí</a>
                                    </div>
                                </div>
                            `
                        });

                        marker.addListener('click', () => {
                            Object.values(infoWindows).forEach(iw => iw.close());
                            infoWindow.open(map, marker);
                            highlightCard(property.slug);
                        });

                        marker.addListener('mouseover', () => highlightCard(property.slug));
                        marker.addListener('mouseout', () => unhighlightCard(property.slug));

                        markers[property.slug] = marker;
                        infoWindows[property.slug] = infoWindow;
                    }
                });
            });

            // Crear/actualizar clusterer despu√©s de que todos los marcadores est√©n listos
            setTimeout(() => {
                const markerArray = Object.values(markers);
                if (clusterer) {
                    clusterer.clearMarkers();
                }

                // Usar MarkerClusterer del objeto global
                if (typeof markerClusterer !== 'undefined' && markerClusterer.MarkerClusterer) {
                    clusterer = new markerClusterer.MarkerClusterer({
                        map,
                        markers: markerArray,
                        renderer: {
                            render: ({ count, position }) => {
                                // Cluster personalizado - TODOS NARANJA HECTOR
                                const color = '#FF6A00';
                                return new google.maps.Marker({
                                    position,
                                    icon: {
                                        url: `data:image/svg+xml;charset=UTF-8,${encodeURIComponent(`
                                            <svg width="50" height="50" xmlns="http://www.w3.org/2000/svg">
                                                <circle cx="25" cy="25" r="22" fill="${color}" stroke="white" stroke-width="3"/>
                                                <text x="25" y="32" font-family="Poppins" font-size="16" font-weight="800" fill="white" text-anchor="middle">${count}</text>
                                            </svg>
                                        `)}`,
                                        scaledSize: new google.maps.Size(50, 50),
                                        anchor: new google.maps.Point(25, 25)
                                    },
                                    label: {
                                        text: count.toString(),
                                        color: 'transparent',
                                        fontSize: '0px'
                                    },
                                    zIndex: Number(google.maps.Marker.MAX_ZINDEX) + count
                                });
                            }
                        }
                    });
                }
            }, 1500); // Esperar a que geocoding termine
        }

        function renderListings(properties) {
            const container = document.getElementById('listings-container');

            if (properties.length === 0) {
                container.innerHTML = '<div class="no-results"><p>üòï No se encontraron propiedades</p><button onclick="resetFilters()">Ver todas</button></div>';
                return;
            }

            container.innerHTML = properties.map((p, index) => {
                // Determinar badges seg√∫n caracter√≠sticas
                const badges = [];
                if (p.price < 2500000) badges.push('<span class="badge green"><i class="fa-solid fa-tag"></i>Precio Bajo</span>');
                if (p.bedrooms >= 4) badges.push('<span class="badge blue"><i class="fa-solid fa-bed"></i>4+ Rec√°maras</span>');
                if (p.sqft >= 200) badges.push('<span class="badge teal"><i class="fa-solid fa-expand"></i>Amplia</span>');
                if (p.zone === 'real-del-valle') badges.push('<span class="badge amber"><i class="fa-solid fa-location-dot"></i>Real del Valle</span>');

                // Generar array de im√°genes (asumimos 5 fotos por propiedad)
                const numPhotos = 5;
                const photos = Array.from({length: numPhotos}, (_, i) =>
                    `../mazatlan/${p.slug}/images/foto-${i+1}.jpg`
                );

                return `
                <div class="listing-card" id="card-${p.slug}" data-card-index="${index}" onmouseenter="highlightMarker('${p.slug}')">
                    <div class="card-carousel-container" style="position:relative" onclick="window.open('../mazatlan/${p.slug}/index.html', '_blank')">
                        <div class="card-carousel-images" id="carousel-${index}">
                            ${photos.map(photo => `<img src="${photo}" class="listing-image" alt="${p.title}" onerror="this.style.display='none'">`).join('')}
                        </div>
                        <div class="media-overlay"></div>
                        <div class="price-badge">${p.priceShort} <small>MXN</small></div>

                        <!-- Flechas carrusel -->
                        <button class="carousel-arrow-card prev" onclick="event.stopPropagation(); changeCardPhoto(${index}, -1)" aria-label="Anterior">
                            <i class="fa-solid fa-chevron-left" style="font-size:14px"></i>
                        </button>
                        <button class="carousel-arrow-card next" onclick="event.stopPropagation(); changeCardPhoto(${index}, 1)" aria-label="Siguiente">
                            <i class="fa-solid fa-chevron-right" style="font-size:14px"></i>
                        </button>

                        <!-- Dots indicadores -->
                        <div class="carousel-dots">
                            ${photos.map((_, i) => `<div class="carousel-dot ${i === 0 ? 'active' : ''}" onclick="event.stopPropagation(); goToCardPhoto(${index}, ${i})"></div>`).join('')}
                        </div>

                        <div class="card-actions">
                            <button class="icon-btn" aria-label="Guardar" onclick="event.stopPropagation()"><i class="fa-regular fa-heart"></i></button>
                            <button class="icon-btn" aria-label="Compartir" onclick="event.stopPropagation()"><i class="fa-solid fa-share-nodes"></i></button>
                        </div>
                    </div>
                    <div class="content">
                        <h3>${p.title}</h3>
                        <p class="headline">üìç ${p.location} ‚Ä¢ ${p.bedrooms} rec√°maras, ${p.bathrooms} ba√±os, ${p.sqft}m¬≤ de construcci√≥n</p>

                        <!-- Ancla de corte para el mapa -->
                        <div class="sheet-cutoff-anchor" aria-hidden="true"></div>

                        <div class="listing-meta">
                            <span>üõèÔ∏è ${p.bedrooms}</span><span class="dot"></span>
                            <span>üöø ${p.bathrooms}</span><span class="dot"></span>
                            <span>üìê ${p.sqft}m¬≤</span>
                        </div>
                        ${badges.length > 0 ? `<div class="badges">${badges.join('')}</div>` : ''}
                    </div>
                </div>
            `}).join('');

            updateCounters(properties.length);

            // Recalcular mediciones despu√©s de renderizar (m√≥vil)
            if (window.innerWidth <= 768 && window.mapInstance) {
                setTimeout(() => {
                    applyCompactSheetAndReveal(window.mapInstance);
                }, 300); // Aumentado para que carguen las im√°genes
            }
        }

        function highlightMarker(slug) {
            const marker = markers[slug];
            if (marker) {
                marker.setAnimation(google.maps.Animation.BOUNCE);
                setTimeout(() => marker.setAnimation(null), 700);
            }
        }

        function highlightCard(slug) {
            document.querySelectorAll('.listing-card').forEach(c => c.classList.remove('highlighted'));
            const card = document.getElementById(`card-${slug}`);
            if (card) {
                card.classList.add('highlighted');
                card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        function unhighlightCard(slug) {
            const card = document.getElementById(`card-${slug}`);
            if (card) card.classList.remove('highlighted');
        }

        function applyFilters() {
            const priceFilter = document.getElementById('filter-price').value;
            const bedroomsFilter = document.getElementById('filter-bedrooms').value;
            const zoneFilter = document.getElementById('filter-zone').value;

            filteredProperties = ALL_PROPERTIES.filter(p => {
                if (priceFilter) {
                    const [min, max] = priceFilter.split('-').map(Number);
                    if (p.price < min || p.price > max) return false;
                }
                if (bedroomsFilter && p.bedrooms !== parseInt(bedroomsFilter)) return false;
                if (zoneFilter && p.zone !== zoneFilter) return false;
                return true;
            });

            renderMarkers(filteredProperties);
            renderListings(filteredProperties);
        }

        function resetFilters() {
            document.getElementById('filter-price').value = '';
            document.getElementById('filter-bedrooms').value = '';
            document.getElementById('filter-zone').value = '';
            applyFilters();
        }

        function updateCounters(count) {
            document.getElementById('visible-count').textContent = count;
            document.getElementById('results-text').textContent = `${count} de ${ALL_PROPERTIES.length} propiedades`;
        }

        // Carousel state management
        const carouselStates = {};

        function changeCardPhoto(cardIndex, direction) {
            if (!carouselStates[cardIndex]) carouselStates[cardIndex] = 0;

            const carousel = document.getElementById(`carousel-${cardIndex}`);
            const numPhotos = carousel.children.length;

            carouselStates[cardIndex] = (carouselStates[cardIndex] + direction + numPhotos) % numPhotos;

            carousel.style.transform = `translateX(-${carouselStates[cardIndex] * 100}%)`;
            updateCarouselDots(cardIndex);
        }

        function goToCardPhoto(cardIndex, photoIndex) {
            carouselStates[cardIndex] = photoIndex;

            const carousel = document.getElementById(`carousel-${cardIndex}`);
            carousel.style.transform = `translateX(-${photoIndex * 100}%)`;
            updateCarouselDots(cardIndex);
        }

        function updateCarouselDots(cardIndex) {
            const card = document.querySelector(`[data-card-index="${cardIndex}"]`);
            const dots = card.querySelectorAll('.carousel-dot');
            dots.forEach((dot, i) => {
                dot.classList.toggle('active', i === carouselStates[cardIndex]);
            });
        }

        document.getElementById('filter-price').addEventListener('change', applyFilters);
        document.getElementById('filter-bedrooms').addEventListener('change', applyFilters);
        document.getElementById('filter-zone').addEventListener('change', applyFilters);

        window.addEventListener('load', initMap);

        /* ===== Din√°mica m√≥vil: medir stack superior, sheet y padding del mapa ===== */

        function measureTopStack() {
            const sb = document.querySelector('.staging-banner');
            const hb = document.querySelector('.header-bar');
            const h1 = sb ? sb.getBoundingClientRect().height : 0;
            const h2 = hb ? hb.getBoundingClientRect().height : 0;
            return Math.round(h1 + h2);
        }

        function measureOneCardHeight() {
            const first = document.querySelector('.listings-section .listing-card');
            if (!first) return 320;
            const h = first.getBoundingClientRect().height;
            return Math.max(280, Math.round(h));
        }

        function applyMobileLayoutMeasurements(map) {
            if (window.innerWidth > 768) return;

            const topStack = measureTopStack();
            const sheetMin = measureOneCardHeight();

            document.documentElement.style.setProperty('--top-stack', `${topStack}px`);
            document.documentElement.style.setProperty('--sheet-min', `${sheetMin}px`);

            const topPadding = topStack + 8;
            const bottomPadding = sheetMin + 16;

            try {
                map?.setOptions({
                    padding: { top: topPadding, bottom: bottomPadding },
                    zoomControlOptions: { position: google.maps.ControlPosition.RIGHT_TOP },
                    fullscreenControlOptions: { position: google.maps.ControlPosition.RIGHT_TOP },
                    streetViewControlOptions: { position: google.maps.ControlPosition.RIGHT_TOP }
                });
            } catch (e) { /* noop */ }
        }

        function enableResponsiveObservers(map) {
            if (window.innerWidth > 768) return;

            const ro = new ResizeObserver(() => applyMobileLayoutMeasurements(map));
            const sb = document.querySelector('.staging-banner');
            const hb = document.querySelector('.header-bar');
            const fb = document.querySelector('.filter-bar');
            const sheet = document.querySelector('.listings-panel');
            const firstCard = document.querySelector('.listings-section .listing-card');

            [sb, hb, fb, sheet, firstCard].forEach(el => { if (el) ro.observe(el); });

            window.addEventListener('resize', () => applyMobileLayoutMeasurements(map));
            window.addEventListener('orientationchange', () => {
                setTimeout(() => applyMobileLayoutMeasurements(map), 250);
            });
        }

        /* ===== MAP-FIRST LOGIC ===== */

        // Desactiva el corte exacto por "construcci√≥n" (puedes reactivarlo luego)
        window.__CUT_TO_CONSTRUCCION__ = false;

        // Mide la primera tarjeta pero LIMITA el sheet a 40dvh para privilegiar el mapa
        function measureSheetMinMapFirst() {
            const sheet = document.querySelector('.listings-section');
            const card = sheet?.querySelector('.listing-card');
            const anchor = window.__CUT_TO_CONSTRUCCION__
                ? sheet?.querySelector('.sheet-cutoff-anchor')
                : null;

            let neededPx;
            if (window.__CUT_TO_CONSTRUCCION__ && anchor && card) {
                const cardBox = card.getBoundingClientRect();
                const targetBox = anchor.getBoundingClientRect();
                const HANDLE = 26, PADDING = 16;
                neededPx = Math.max(240, Math.round(targetBox.bottom - cardBox.top) + HANDLE + PADDING);
            } else {
                // Estimaci√≥n segura: 1 tarjeta completa com√∫n
                neededPx = 320; // puedes ajustar a tu card real
            }

            // Limita el sheet a 40dvh para que el mapa quede grande
            const sheetMax = Math.round(window.innerHeight * 0.40);
            const sheetMin = Math.min(neededPx, sheetMax);

            document.documentElement.style.setProperty('--sheet-min', sheetMin + 'px');
        }

        function applyMapFirstPadding(map) {
            const sheet = document.querySelector('.listings-section');
            if (!map || !sheet) return;
            const sheetH = sheet.getBoundingClientRect().height;
            const topStack = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--top-stack')) || 56;
            const topPadding = topStack + 8;
            const bottomPadding = Math.round(sheetH) + 16;

            map.setOptions({
                padding: { top: topPadding, bottom: bottomPadding },
                zoomControlOptions: { position: google.maps.ControlPosition.RIGHT_TOP },
                fullscreenControlOptions: { position: google.maps.ControlPosition.RIGHT_TOP },
                streetViewControlOptions: { position: google.maps.ControlPosition.RIGHT_TOP }
            });
        }

        function initMapFirst(map) {
            if (window.innerWidth > 768) return;
            // 1) Mide y fija l√≠mites
            measureSheetMinMapFirst();
            // 2) Aplica padding adecuado al mapa
            applyMapFirstPadding(map);

            // Recalcular en eventos t√≠picos
            const reapply = () => { measureSheetMinMapFirst(); applyMapFirstPadding(map); };
            window.addEventListener('resize', reapply);
            window.addEventListener('orientationchange', () => setTimeout(reapply, 250));
            map.addListener('idle', reapply);

            // Si usas clusterer, al terminar clustering re-aplica
            if (window.clustererInstance) {
                try {
                    window.clustererInstance.addListener('clusteringend', reapply);
                } catch (e) { /* noop */ }
            }

            // Reaplica cuando carguen im√°genes de la primera tarjeta
            const firstCard = document.querySelector('.listings-section .listing-card');
            if (firstCard) {
                firstCard.querySelectorAll('img').forEach(img => {
                    if (!img.complete) {
                        img.addEventListener('load', reapply, { once: true });
                        img.addEventListener('error', reapply, { once: true });
                    }
                });
            }
        }

        // ===== TARJETA COMPACTA FIJA (sin expansi√≥n) =====

        /* Calcula altura del sheet para: UNA tarjeta COMPLETA visible sin espacio extra */
        function computeCompactSheetHeight() {
            const sheet = document.querySelector('.listings-section');
            const card = sheet?.querySelector('.listing-card');
            if (!sheet || !card) return Math.round(window.innerHeight * 0.36); // fallback

            // Medir la altura TOTAL de la primera tarjeta (completa)
            const cardBox = card.getBoundingClientRect();
            const cardFullHeight = cardBox.height;

            // Solo agregar el padding TOP del sheet (el card ya tiene margin-bottom incluido)
            const SHEET_PADDING_TOP = 8;
            const BREATHING_ROOM = 4; // m√≠nimo espacio para que no se vea cortado

            let total = SHEET_PADDING_TOP + cardFullHeight + BREATHING_ROOM;

            // Limitar a un rango razonable
            const minPx = 260; // m√≠nimo
            const maxPx = Math.round(window.innerHeight * 0.40); // m√°x 40dvh
            total = Math.max(minPx, Math.min(total, maxPx));

            return Math.round(total);
        }

        /* Aplica altura fija compacta y asegura que el primer card se vea */
        function applyCompactSheetAndReveal(map) {
            if (window.innerWidth > 768) return;
            const sheet = document.querySelector('.listings-section');
            if (!sheet) return;

            // 1) fija altura compacta
            const fixed = computeCompactSheetHeight();
            document.documentElement.style.setProperty('--sheet-fixed', fixed + 'px');

            // 2) resetea scroll al tope para que el primer card quede visible
            sheet.scrollTop = 0;

            // 3) padding del mapa para que controles/atribuciones no queden tapados
            try {
                const topStack = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--top-stack')) || 56;
                map?.setOptions({
                    padding: {
                        top: topStack + 8,
                        bottom: fixed + 12
                    },
                    zoomControlOptions: { position: google.maps.ControlPosition.RIGHT_TOP },
                    fullscreenControlOptions: { position: google.maps.ControlPosition.RIGHT_TOP },
                    streetViewControlOptions: { position: google.maps.ControlPosition.RIGHT_TOP }
                });
            } catch (e) { /* noop */ }
        }

        /** Bloquea cualquier l√≥gica previa que expand√≠a el sheet en taps. */
        function disableSheetExpansion() {
            // Si ten√≠as un toggle por handle, lo eliminamos
            const sheet = document.querySelector('.listings-section');
            if (!sheet) return;
            // Borra listeners anteriores del handle (si exist√≠an)
            sheet.onclick = null;

            // Si definiste funciones tipo setSheetState/enableSheetHandleToggle, las anulamos
            window.setSheetState = function () { /* noop: no expandir */ };
            window.enableSheetHandleToggle = function () { /* noop */ };
        }

        /* Reaplicar en eventos t√≠picos */
        function enableCompactReapply(map) {
            if (window.innerWidth > 768) return;
            const reapply = () => applyCompactSheetAndReveal(map);

            window.addEventListener('resize', reapply);
            window.addEventListener('orientationchange', () => setTimeout(reapply, 250));
            map?.addListener('idle', reapply);

            // cuando carguen las im√°genes del primer card
            const first = document.querySelector('.listings-section .listing-card');
            if (first) {
                first.querySelectorAll('img').forEach(img => {
                    if (!img.complete) {
                        img.addEventListener('load', reapply, { once: true });
                        img.addEventListener('error', reapply, { once: true });
                    }
                });
            }
        }

        // ===== ANTI-JITTER SYSTEM =====
        // Utilidades
        function debounce(fn, ms=120){
            let t;
            return (...a)=>{
                clearTimeout(t);
                t=setTimeout(()=>fn(...a), ms);
            };
        }

        function rafThrottle(fn){
            let busy=false;
            return (...a)=>{
                if(busy) return;
                busy=true;
                requestAnimationFrame(()=>{
                    fn(...a);
                    busy=false;
                });
            };
        }

        // Congela/Descongela transiciones del sheet mientras anima el mapa
        function lockSheetDuringMapAnim(lock=true){
            document.body.classList.toggle('map-animating', !!lock);
        }

        // Ajusta la altura del contenedor del mapa a p√≠xel entero (evita subp√≠xel que genera "grieta")
        function snapMapHeightToDevicePixel(){
            const mapSection = document.querySelector('.map-section');
            if(!mapSection) return;
            const r = mapSection.getBoundingClientRect();
            const snapped = Math.floor(r.height);
            if(Math.abs(r.height - snapped) >= 0.5){
                mapSection.style.height = snapped + 'px';
            }
        }

        // Reaplica todas las mediciones clave en m√≥vil
        const remeasureAll = debounce(() => {
            snapMapHeightToDevicePixel();
            applyMobileLayoutMeasurements(window.mapInstance);
            applySheetCutAtConstruction(window.mapInstance);
        }, 80);

        // Hooks de eventos del Mapa
        function hookMapViewport(map){
            if(!map || window.innerWidth > 768) return;

            // Antes de que empiece a cambiar el viewport
            map.addListener('zoom_changed', () => { lockSheetDuringMapAnim(true); });
            map.addListener('dragstart',     () => { lockSheetDuringMapAnim(true); });

            // Cuando termina cualquier animaci√≥n (zoom/pan/fitBounds, etc.)
            map.addListener('idle', () => {
                lockSheetDuringMapAnim(false);
                remeasureAll();
            });

            // Por si cambia el tipo de mapa/proyecci√≥n y var√≠an controles
            map.addListener('maptypeid_changed', remeasureAll);
            map.addListener('projection_changed', remeasureAll);

            // Resnap cuando cambia tama√±o de viewport
            window.addEventListener('resize', remeasureAll);
            window.addEventListener('orientationchange', ()=> setTimeout(remeasureAll, 250));
        }

        // Mitigar cambios de altura por im√°genes dentro de la primera tarjeta
        function watchCardImages(){
            if(window.innerWidth > 768) return;
            const sheet = document.querySelector('.listings-section');
            if(!sheet) return;
            const firstCard = sheet.querySelector('.listing-card');
            if(!firstCard) return;

            // Recalcular cuando las im√°genes del carrusel (o la primera foto) terminen de cargar
            const imgs = firstCard.querySelectorAll('img');
            imgs.forEach(img=>{
                if(!img.complete){
                    img.addEventListener('load',  remeasureAll, { once:true });
                    img.addEventListener('error', remeasureAll, { once:true });
                }
            });
        }

        // Aplicar al cargar en m√≥vil
        window.addEventListener('load', () => {
            if (window.innerWidth <= 768 && map) {
                window.mapInstance = map;
                setTimeout(() => {
                    // TARJETA COMPACTA FIJA: Sistema principal (no expandible)
                    disableSheetExpansion();
                    applyCompactSheetAndReveal(map);
                    enableCompactReapply(map);

                    // Anti-jitter system
                    hookMapViewport(map);
                    snapMapHeightToDevicePixel();
                }, 500);
            }
        });
    </script>

</body>
</html>
